<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SI-PAJUR - Sistem Peminjaman Aset Jurusan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles untuk warna tema */
        .bg-primary { background-color: #800000; } /* Maroon */
        .text-primary { color: #800000; }
        .border-primary { border-color: #800000; }
        .bg-secondary { background-color: #FFD700; } /* Kuning Emas */
        .text-secondary { color: #FFD700; }
        .btn-primary {
            background-color: #800000;
            color: white;
            transition: background-color 0.3s;
        }
        .btn-primary:hover {
            background-color: #660000;
        }
        .btn-secondary {
            background-color: #FFD700;
            color: #333;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #FFC700;
        }
        .tab-active {
            border-bottom: 2px solid #800000;
            color: #800000;
            font-weight: 600;
        }
        .tab-inactive {
            border-bottom: 2px solid transparent;
            color: #6b7280;
        }
        .toast {
            visibility: hidden;
            min-width: 250px;
            margin-left: -125px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 2px;
            padding: 16px;
            position: fixed;
            z-index: 100;
            left: 50%;
            bottom: 30px;
            font-size: 17px;
            opacity: 0;
            transition: visibility 0s 0.5s, opacity 0.5s linear;
        }
        .toast.show {
            visibility: visible;
            opacity: 1;
            transition: opacity 0.5s;
        }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Container Utama -->
    <div id="app" class="max-w-md mx-auto bg-white min-h-screen shadow-lg">

        <!-- =================================================================== -->
        <!--                          LAYAR LOGIN                                -->
        <!-- =================================================================== -->
        <div id="login-screen" class="p-6">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-primary">SI-PAJUR</h1>
                <p class="text-gray-500">Sistem Informasi Peminjaman Aset Jurusan</p>
            </div>

            <!-- Tab Pilihan Login -->
            <div class="flex border-b mb-6">
                <button id="login-user-tab" class="flex-1 py-2 text-center tab-active" onclick="switchLoginTab('user')">Pengguna</button>
                <button id="login-admin-tab" class="flex-1 py-2 text-center tab-inactive" onclick="switchLoginTab('admin')">Admin</button>
            </div>

            <!-- Form Login Pengguna -->
            <form id="login-user-form" onsubmit="event.preventDefault(); login('user');">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Login sebagai:</label>
                    <div class="flex space-x-4">
                        <label class="flex items-center">
                            <input type="radio" name="login_user_type" value="mahasiswa" class="text-primary focus:ring-primary" onchange="switchLoginFormIdentifier('mahasiswa')" checked>
                            <span class="ml-2">Mahasiswa</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="login_user_type" value="dosen" class="text-primary focus:ring-primary" onchange="switchLoginFormIdentifier('dosen')">
                            <span class="ml-2">Dosen</span>
                        </label>
                         <label class="flex items-center">
                            <input type="radio" name="login_user_type" value="pegawai" class="text-primary focus:ring-primary" onchange="switchLoginFormIdentifier('pegawai')">
                            <span class="ml-2">Pegawai</span>
                        </label>
                    </div>
                </div>
                
                <div id="login-nim-input" class="mb-4">
                    <label for="login-identifier" class="block text-sm font-medium text-gray-700">NIM</label>
                    <input type="text" id="login-identifier" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary" placeholder="Masukkan NIM" required>
                </div>

                <div class="mb-6">
                    <label for="login-password-user" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="login-password-user" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary" placeholder="******" required>
                </div>
                <button type="submit" class="w-full btn-primary font-bold py-2 px-4 rounded-md">
                    Login
                </button>
            </form>
            
            <!-- Form Login Admin -->
            <form id="login-admin-form" class="hidden" onsubmit="event.preventDefault(); login('admin');">
                 <div class="mb-4">
                    <label for="login-admin-id" class="block text-sm font-medium text-gray-700">ID Admin</label>
                    <input type="text" id="login-admin-id" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary" placeholder="Default: admin" required>
                </div>
                <div class="mb-6">
                    <label for="login-password-admin" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="login-password-admin" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary" placeholder="Default: admin" required>
                </div>
                <button type="submit" class="w-full btn-primary font-bold py-2 px-4 rounded-md">
                    Login Admin
                </button>
            </form>

            <p class="mt-8 text-center text-sm">
                Belum punya akun? 
                <button class="font-medium text-primary hover:underline" onclick="showScreen('register-screen')">Registrasi di sini</button>
            </p>
        </div>

        <!-- =================================================================== -->
        <!--                        LAYAR REGISTRASI                             -->
        <!-- =================================================================== -->
        <div id="register-screen" class="p-6 hidden">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold text-primary">Registrasi Akun</h1>
                <p class="text-gray-500">Pilih jenis pengguna</p>
            </div>

            <!-- Pilihan Jenis Pengguna -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 mb-2">Saya adalah seorang:</label>
                <div class="flex space-x-4">
                    <label class="flex items-center">
                        <input type="radio" name="user_type" value="mahasiswa" class="text-primary focus:ring-primary" onchange="switchRegisterForm('mahasiswa')" checked>
                        <span class="ml-2">Mahasiswa</span>
                    </label>
                    <label class="flex items-center">
                        <input type="radio" name="user_type" value="dosen_pegawai" class="text-primary focus:ring-primary" onchange="switchRegisterForm('dosen_pegawai')">
                        <span class="ml-2">Dosen / Pegawai</span>
                    </label>
                </div>
            </div>

            <!-- Form Registrasi Mahasiswa -->
            <form id="register-mahasiswa-form" onsubmit="event.preventDefault(); registerUser();">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                    <input type="text" id="reg-mhs-nama" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary" placeholder="Nama Lengkap" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">NIM</label>
                    <input type="text" id="reg-mhs-nim" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary" placeholder="Nomor Induk Mahasiswa" required>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Angkatan</label>
                        <input type="number" id="reg-mhs-angkatan" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary" placeholder="2022" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Prodi</label>
                        <input type="text" id="reg-mhs-prodi" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary" placeholder="Sistem Informasi" required>
                    </div>
                </div>
                 <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="reg-mhs-password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="******" required>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700">Konfirmasi Password</label>
                    <input type="password" id="reg-mhs-confirm-password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="******" required>
                </div>
                 <button type="submit" class="w-full btn-primary font-bold py-2 px-4 rounded-md">
                    Registrasi
                </button>
            </form>
            
            <!-- Form Registrasi Dosen/Pegawai -->
            <form id="register-dosen-pegawai-form" class="hidden" onsubmit="event.preventDefault(); registerUser();">
                 <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Nama Lengkap</label>
                    <input type="text" id="reg-dp-nama" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Nama Lengkap dengan Gelar" required>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">NIP</label>
                    <input type="text" id="reg-dp-nip" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Nomor Induk Pegawai" required>
                </div>
                 <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Jabatan</label>
                    <input type="text" id="reg-dp-jabatan" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g. Dosen, Staf Akademik" required>
                </div>
                 <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="reg-dp-password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="******" required>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700">Konfirmasi Password</label>
                    <input type="password" id="reg-dp-confirm-password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="******" required>
                </div>
                <button type="submit" class="w-full btn-primary font-bold py-2 px-4 rounded-md">
                    Registrasi
                </button>
            </form>

             <p class="mt-8 text-center text-sm">
                Sudah punya akun? 
                <button class="font-medium text-primary hover:underline" onclick="showScreen('login-screen')">Login di sini</button>
            </p>
        </div>

        <!-- =================================================================== -->
        <!--                        BERANDA PENGGUNA                             -->
        <!-- =================================================================== -->
        <div id="user-dashboard-screen" class="hidden">
            <!-- Header -->
            <header class="bg-primary p-4 flex justify-between items-center">
                <h1 class="text-white text-xl font-bold">Beranda Pengguna</h1>
                <button class="text-white hover:bg-red-900 p-2 rounded-full" title="Logout" onclick="logout()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                </button>
            </header>

            <div class="p-6">
                <!-- Info Pengguna -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                    <p id="user-info-name" class="font-bold text-lg text-gray-800"></p>
                    <p id="user-info-detail" class="text-sm text-gray-500"></p>
                </div>

                <!-- Menu Utama -->
                <div class="grid grid-cols-2 gap-4 mb-8">
                    <button class="bg-primary text-white p-4 rounded-lg shadow-md flex flex-col items-center justify-center space-y-2 hover:bg-red-900" onclick="showModal('peminjaman-modal')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v3m0 0v3m0-3h3m-3 0H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <span class="font-semibold">Pinjam Alat</span>
                    </button>
                    <button class="bg-gray-200 text-gray-800 p-4 rounded-lg shadow-md flex flex-col items-center justify-center space-y-2 hover:bg-gray-300" onclick="showModal('daftar-alat-modal')">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16" /></svg>
                        <span class="font-semibold">Daftar Alat</span>
                    </button>
                </div>

                <!-- Peminjaman Terkini -->
                <div>
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Peminjaman Terkini</h2>
                    <div id="peminjaman-terkini-list" class="space-y-4">
                        <!-- Konten dinamis dari JS -->
                    </div>
                </div>
                
                <!-- Riwayat Peminjaman -->
                <div class="mt-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Riwayat Peminjaman</h2>
                    <div id="riwayat-peminjaman-list" class="space-y-3">
                         <!-- Konten dinamis dari JS -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- =================================================================== -->
        <!--                        BERANDA ADMIN                                -->
        <!-- =================================================================== -->
        <div id="admin-dashboard-screen" class="hidden">
            <!-- Header -->
            <header class="bg-primary p-4 flex justify-between items-center">
                <h1 class="text-white text-xl font-bold">Dashboard Admin</h1>
                <button class="text-white hover:bg-red-900 p-2 rounded-full" title="Logout" onclick="logout()">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                </button>
            </header>
            
            <div class="p-6">
                <!-- Info Admin -->
                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-6">
                    <p class="font-bold text-lg text-gray-800">Admin Jurusan</p>
                    <p class="text-sm text-gray-500">Operator Aktif</p>
                </div>

                <!-- Menu Utama Admin -->
                <div class="grid grid-cols-2 gap-4 mb-8">
                    <button class="bg-primary text-white p-4 rounded-lg shadow-md flex flex-col items-center justify-center space-y-2 hover:bg-red-900" onclick="showModal('input-alat-modal')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                        <span class="font-semibold text-center">Input Data Alat</span>
                    </button>
                    <button class="bg-gray-200 text-gray-800 p-4 rounded-lg shadow-md flex flex-col items-center justify-center space-y-2 hover:bg-gray-300" onclick="showModal('daftar-alat-admin-modal')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                        <span class="font-semibold text-center">Kelola Daftar Alat</span>
                    </button>
                    <button class="bg-gray-200 text-gray-800 p-4 rounded-lg shadow-md flex flex-col items-center justify-center space-y-2 hover:bg-gray-300 col-span-2" onclick="showModal('riwayat-peminjam-modal')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg>
                        <span class="font-semibold text-center">Lihat Riwayat Peminjam</span>
                    </button>
                </div>
                
                <!-- Daftar Peminjam Real-time -->
                <div>
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Peminjaman Aktif</h2>
                    <div id="admin-peminjaman-aktif-list" class="space-y-4">
                        <!-- Konten dinamis dari JS -->
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- =================================================================== -->
    <!--                             MODALS                                  -->
    <!-- =================================================================== -->
    <!-- Modal Peminjaman -->
    <div id="peminjaman-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative max-h-screen overflow-y-auto">
            <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800" onclick="closeModal('peminjaman-modal')">&times;</button>
            <h2 class="text-2xl font-bold text-primary mb-4">Form Peminjaman</h2>
            <form id="form-peminjaman" onsubmit="event.preventDefault(); ajukanPeminjaman();" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Jenis Alat</label>
                    <select id="pinjam-jenis-alat" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                        <!-- Opsi dinamis dari JS -->
                    </select>
                </div>

                <!-- Form Peminjaman Mahasiswa -->
                <div id="peminjaman-form-mahasiswa" class="hidden space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Keperluan</label>
                        <select id="pinjam-keperluan-mhs" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" onchange="handleKeperluanChange(this.value,'mahasiswa')" required>
                            <option value="">Pilih Keperluan...</option>
                            <option value="matakuliah">Untuk Mata Kuliah</option>
                            <option value="lainnya">Lainnya</option>
                        </select>
                    </div>
                    <div id="detail-matkul-form" class="hidden space-y-4 p-4 bg-gray-50 rounded-md border">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Mata Kuliah</label>
                            <input type="text" id="pinjam-matkul" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g. Basis Data">
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700">Dosen Pengampu</label>
                            <input type="text" id="pinjam-dosen" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g. Dr. Jane Smith">
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700">Kelas</label>
                            <input type="text" id="pinjam-kelas" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g. SI-3A">
                        </div>
                    </div>
                </div>

                <!-- Form Peminjaman Dosen -->
                <div id="peminjaman-form-dosen" class="hidden space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Keperluan</label>
                        <select id="pinjam-keperluan-dosen" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" onchange="handleKeperluanChange(this.value, 'dosen')" required>
                            <option value="">Pilih Keperluan...</option>
                            <option value="mengajar">Untuk Mengajar</option>
                            <option value="lainnya">Lainnya</option>
                        </select>
                    </div>
                    <div id="detail-mengajar-form" class="hidden space-y-4 p-4 bg-gray-50 rounded-md border">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Mata Kuliah</label>
                            <input type="text" id="pinjam-matkul-dosen" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g. Algoritma Pemrograman">
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700">Kelas</label>
                            <input type="text" id="pinjam-kelas-dosen" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g. SI-1A, SI-1B">
                        </div>
                    </div>
                </div>
                
                <!-- Form Peminjaman Pegawai -->
                <div id="peminjaman-form-pegawai" class="hidden space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Keperluan</label>
                        <select id="pinjam-keperluan-pegawai" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" onchange="handleKeperluanChange(this.value, 'pegawai')" required>
                            <option value="">Pilih Keperluan...</option>
                            <option value="kegiatan">Untuk Kegiatan Kampus</option>
                            <option value="lainnya">Lainnya</option>
                        </select>
                    </div>
                    <div id="detail-kegiatan-form" class="hidden space-y-4 p-4 bg-gray-50 rounded-md border">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Nama Kegiatan</label>
                            <input type="text" id="pinjam-kegiatan" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g. Rapat Anggaran">
                        </div>
                         <div>
                            <label class="block text-sm font-medium text-gray-700">Lokasi Kegiatan</label>
                            <input type="text" id="pinjam-lokasi" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g. Ruang Rapat Jurusan">
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-4 pt-4 border-t">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tgl & Waktu Pinjam</label>
                        <input type="datetime-local" id="pinjam-waktu-pinjam" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700">Batas Pengembalian</label>
                        <input type="datetime-local" id="pinjam-waktu-kembali" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                    </div>
                </div>
                <button type="submit" class="w-full btn-primary font-bold py-2 px-4 rounded-md">Ajukan Peminjaman</button>
            </form>
        </div>
    </div>
    
    <!-- Modal Daftar Alat -->
    <div id="daftar-alat-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative max-h-screen overflow-y-auto">
            <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800" onclick="closeModal('daftar-alat-modal')">&times;</button>
            <h2 class="text-2xl font-bold text-primary mb-4">Daftar Alat Tersedia</h2>
            <ul id="user-daftar-alat-list" class="space-y-3">
                <!-- Konten dinamis dari JS -->
            </ul>
        </div>
    </div>
    
    <!-- Modal Kembalikan Alat -->
    <div id="kembalikan-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative">
            <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800" onclick="closeModal('kembalikan-modal')">&times;</button>
            <h2 class="text-2xl font-bold text-primary mb-4">Konfirmasi Pengembalian</h2>
            <p class="text-gray-600 mb-4">Silakan unggah bukti pengembalian alat (misal: foto alat sudah diletakkan di tempatnya).</p>
            <form id="form-kembalikan" onsubmit="event.preventDefault(); kembalikanAlat();">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Upload Bukti</label>
                    <input type="file" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-primary file:text-white hover:file:bg-red-900" required/>
                </div>
                <button type="submit" class="w-full mt-6 btn-primary font-bold py-2 px-4 rounded-md">Konfirmasi Pengembalian</button>
            </form>
        </div>
    </div>
    
    <!-- Modal Input Alat (Admin) -->
    <div id="input-alat-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative max-h-screen overflow-y-auto">
            <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800" onclick="closeModal('input-alat-modal')">&times;</button>
            <h2 class="text-2xl font-bold text-primary mb-4">Input Data Alat Baru</h2>
             <form id="form-input-alat" onsubmit="event.preventDefault(); simpanAlatBaru();" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nama Alat</label>
                    <input id="input-nama-alat" type="text" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="e.g. Proyektor InFocus" required>
                </div>
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Jumlah</label>
                        <input id="input-jumlah-alat" type="number" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="5" required>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700">Kelengkapan</label>
                        <input id="input-kelengkapan-alat" type="text" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Kabel Power, Tas" required>
                    </div>
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700">Deskripsi (Opsional)</label>
                    <textarea id="input-deskripsi-alat" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" placeholder="Proyektor untuk ruang kelas besar..."></textarea>
                </div>
                <button type="submit" class="w-full btn-primary font-bold py-2 px-4 rounded-md">Simpan Alat</button>
            </form>
        </div>
    </div>

    <!-- Modal Kelola Daftar Alat (Admin) -->
    <div id="daftar-alat-admin-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative max-h-screen overflow-y-auto">
             <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800" onclick="closeModal('daftar-alat-admin-modal')">&times;</button>
            <h2 class="text-2xl font-bold text-primary mb-4">Kelola Daftar Alat</h2>
            <div id="admin-kelola-alat-list" class="space-y-3">
                <!-- Konten dinamis dari JS -->
            </div>
        </div>
    </div>
    
    <!-- Modal Edit Alat (Admin) -->
    <div id="edit-alat-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative max-h-screen overflow-y-auto">
            <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800" onclick="closeModal('edit-alat-modal')">&times;</button>
            <h2 class="text-2xl font-bold text-primary mb-4">Edit Data Alat</h2>
             <form id="form-edit-alat" onsubmit="event.preventDefault(); simpanPerubahanAlat();" class="space-y-4">
                <input type="hidden" id="edit-alat-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Nama Alat</label>
                    <input id="edit-nama-alat" type="text" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                </div>
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Jumlah</label>
                        <input id="edit-jumlah-alat" type="number" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                    </div>
                     <div>
                        <label class="block text-sm font-medium text-gray-700">Kelengkapan</label>
                        <input id="edit-kelengkapan-alat" type="text" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm" required>
                    </div>
                </div>
                 <div>
                    <label class="block text-sm font-medium text-gray-700">Deskripsi (Opsional)</label>
                    <textarea id="edit-deskripsi-alat" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm"></textarea>
                </div>
                <button type="submit" class="w-full btn-primary font-bold py-2 px-4 rounded-md">Simpan Perubahan</button>
            </form>
        </div>
    </div>

    <!-- Modal Riwayat Peminjam (Admin) -->
    <div id="riwayat-peminjam-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 relative max-h-screen overflow-y-auto">
             <button class="absolute top-4 right-4 text-gray-500 hover:text-gray-800" onclick="closeModal('riwayat-peminjam-modal')">&times;</button>
            <h2 class="text-2xl font-bold text-primary mb-4">Riwayat Peminjaman</h2>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Filter berdasarkan tanggal</label>
                <input type="date" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
            </div>
            <div id="admin-riwayat-list" class="space-y-4">
                <!-- Konten dinamis dari JS -->
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
    // ===================================================================
    //                           DATABASE SEMENTARA
    // ===================================================================
    let users = [];
    let alat = [];
    let peminjaman = [];
    let currentUser = null;
    let nextPeminjamanId = 1;

    // ===================================================================
    //                           STATE MANAGEMENT
    // ===================================================================
    function showScreen(screenId) {
        document.querySelectorAll('#app > div').forEach(screen => screen.classList.add('hidden'));
        document.getElementById(screenId).classList.remove('hidden');
    }

    function showModal(modalId) {
        // Persiapan sebelum menampilkan modal
        if (modalId === 'peminjaman-modal') preparePeminjamanForm();
        if (modalId === 'daftar-alat-modal') renderDaftarAlatUser();
        if (modalId === 'daftar-alat-admin-modal') renderKelolaAlatAdmin();
        if (modalId === 'riwayat-peminjam-modal') renderAdminRiwayat();

        document.getElementById(modalId).classList.remove('hidden');
    }

    function closeModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
    }
    
    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => {
            toast.classList.remove('show');
        }, 3000);
    }

    // ===================================================================
    //                           LOGIC UTAMA APLIKASI
    // ===================================================================

    // Inisialisasi Data Awal
    function initData() {
        // Data Admin
        users.push({ type: 'admin', id: 'admin', password: 'admin' });
        // Data Mahasiswa
        users.push({ type: 'mahasiswa', nama: 'Budi Hartono', identifier: '12345', password: '123', angkatan: '2021', prodi: 'Sistem Informasi' });
        // Data Dosen
        users.push({ type: 'dosen', nama: 'Dr. Jane Smith', identifier: '54321', password: '123', jabatan: 'Dosen' });
        // Data Pegawai
        users.push({ type: 'pegawai', nama: 'Siti Aminah', identifier: '98765', password: '123', jabatan: 'Staf Akademik' });
        
        // Data Alat
        alat = [
            { id: 1, nama: 'Proyektor LCD Epson', jumlah: 3, tersedia: 2, kelengkapan: 'Kabel Power, Tas', deskripsi: 'Proyektor untuk ruang kelas besar.' },
            { id: 2, nama: 'Konektor HDMI', jumlah: 8, tersedia: 8, kelengkapan: 'Unit only', deskripsi: '' },
            { id: 3, nama: 'Stop Kontak 5 Lubang', jumlah: 12, tersedia: 10, kelengkapan: 'Kabel 3 meter', deskripsi: '' },
            { id: 4, nama: 'Kabel VGA', jumlah: 5, tersedia: 5, kelengkapan: 'Unit only', deskripsi: '' }
        ];

        // Data Peminjaman
        peminjaman = [
            { id: nextPeminjamanId++, userId: '12345', alatId: 1, waktuPinjam: '2025-10-06T10:00', waktuKembali: '2025-10-06T12:00', status: 'Selesai', detail: { keperluan: 'Lainnya' } },
            { id: nextPeminjamanId++, userId: '54321', alatId: 3, waktuPinjam: '2025-10-07T08:00', batasKembali: '2025-10-07T17:00', status: 'Dipinjam', detail: { keperluan: 'Mengajar', matkul: 'Struktur Data', kelas: 'A' } },
            { id: nextPeminjamanId++, userId: '98765', alatId: 3, waktuPinjam: '2025-10-05T13:00', waktuKembali: '2025-10-05T15:00', status: 'Selesai', detail: { keperluan: 'Kegiatan Kampus', kegiatan: 'Rapat Jurusan', lokasi: 'Ruang Rapat' } }
        ];
    }

    // Fungsi Registrasi
    function registerUser() {
        const userTypeRadio = document.querySelector('input[name="user_type"]:checked').value;

        if (userTypeRadio === 'mahasiswa') {
            const nama = document.getElementById('reg-mhs-nama').value.trim();
            const nim = document.getElementById('reg-mhs-nim').value.trim();
            const angkatan = document.getElementById('reg-mhs-angkatan').value;
            const prodi = document.getElementById('reg-mhs-prodi').value.trim();
            const password = document.getElementById('reg-mhs-password').value;
            const confirmPassword = document.getElementById('reg-mhs-confirm-password').value;

            if (!nama || !nim || !angkatan || !prodi || !password) {
                showToast("Semua kolom wajib diisi.");
                return;
            }
            if (password !== confirmPassword) {
                showToast("Konfirmasi password tidak cocok.");
                return;
            }
            if (users.some(u => u.identifier === nim)) {
                showToast("NIM sudah terdaftar.");
                return;
            }

            const newUser = {
                type: 'mahasiswa',
                nama: nama,
                identifier: nim,
                password: password,
                angkatan: angkatan,
                prodi: prodi
            };
            users.push(newUser);

        } else { // Dosen / Pegawai
            const nama = document.getElementById('reg-dp-nama').value.trim();
            const nip = document.getElementById('reg-dp-nip').value.trim();
            const jabatan = document.getElementById('reg-dp-jabatan').value.trim();
            const password = document.getElementById('reg-dp-password').value;
            const confirmPassword = document.getElementById('reg-dp-confirm-password').value;

            if (!nama || !nip || !jabatan || !password) {
                showToast("Semua kolom wajib diisi.");
                return;
            }
            if (password !== confirmPassword) {
                showToast("Konfirmasi password tidak cocok.");
                return;
            }
            if (users.some(u => u.identifier === nip)) {
                showToast("NIP sudah terdaftar.");
                return;
            }
            
            const determinedType = jabatan.toLowerCase().includes('dosen') ? 'dosen' : 'pegawai';

            const newUser = {
                type: determinedType,
                nama: nama,
                identifier: nip,
                password: password,
                jabatan: jabatan
            };
            users.push(newUser);
        }
        
        showToast("Registrasi berhasil! Silakan login.");
        document.getElementById('register-mahasiswa-form').reset();
        document.getElementById('register-dosen-pegawai-form').reset();
        showScreen('login-screen');
    }

    // Fungsi Login
    function login(type) {
        if (type === 'user') {
            const userType = document.querySelector('input[name="login_user_type"]:checked').value;
            const identifier = document.getElementById('login-identifier').value;
            const password = document.getElementById('login-password-user').value;
            
            const foundUser = users.find(u => u.type === userType && u.identifier === identifier && u.password === password);
            if (foundUser) {
                currentUser = foundUser;
                updateUserDashboard();
                showScreen('user-dashboard-screen');
            } else {
                showToast("NIM/NIP atau Password salah.");
            }
        } else { // Admin
            const id = document.getElementById('login-admin-id').value;
            const pass = document.getElementById('login-password-admin').value;
            const foundAdmin = users.find(u => u.type === 'admin' && u.id === id && u.password === pass);
            if(foundAdmin) {
                currentUser = foundAdmin;
                updateAdminDashboard();
                showScreen('admin-dashboard-screen');
            } else {
                showToast("ID Admin atau Password salah.");
            }
        }
    }
    
    // Fungsi Logout
    function logout() {
        currentUser = null;
        document.getElementById('login-user-form').reset();
        document.getElementById('login-admin-form').reset();
        showScreen('login-screen');
    }

    // Fungsi Update Tampilan (Rendering)
    function updateUserDashboard() {
        document.getElementById('user-info-name').textContent = `Selamat Datang, ${currentUser.nama}!`;
        let detail = '';
        if (currentUser.type === 'mahasiswa') detail = `Mahasiswa - ${currentUser.prodi} ${currentUser.angkatan}`;
        else if (currentUser.type === 'dosen') detail = `${currentUser.jabatan} - NIP: ${currentUser.identifier}`;
        else detail = `${currentUser.jabatan} - NIP: ${currentUser.identifier}`;
        document.getElementById('user-info-detail').textContent = detail;
        renderPeminjamanTerkini();
        renderRiwayatPeminjaman();
    }
    
    function updateAdminDashboard() {
        renderAdminPeminjamanAktif();
    }

    function renderPeminjamanTerkini() {
        const listContainer = document.getElementById('peminjaman-terkini-list');
        listContainer.innerHTML = '';
        const pinjamanAktif = peminjaman.filter(p => p.userId === currentUser.identifier && p.status === 'Dipinjam');
        
        if (pinjamanAktif.length === 0) {
            listContainer.innerHTML = '<p class="text-gray-500 text-center">Tidak ada peminjaman aktif.</p>';
            return;
        }

        pinjamanAktif.forEach(p => {
            const alatInfo = alat.find(a => a.id === p.alatId);
            listContainer.innerHTML += `
                <div class="bg-white p-4 rounded-lg border border-gray-200">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-primary">${alatInfo.nama}</h3>
                            <p class="text-sm text-gray-500">Batas Kembali: ${new Date(p.batasKembali).toLocaleString('id-ID')}</p>
                        </div>
                        <span class="text-xs font-semibold bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Dipinjam</span>
                    </div>
                    <button class="w-full mt-4 btn-secondary font-bold py-2 px-4 rounded-md text-sm" onclick="openKembalikanModal(${p.id})">
                        Kembalikan Alat
                    </button>
                </div>
            `;
        });
    }
    
    function renderRiwayatPeminjaman() {
        const listContainer = document.getElementById('riwayat-peminjaman-list');
        listContainer.innerHTML = '';
        const pinjamanSelesai = peminjaman.filter(p => p.userId === currentUser.identifier && p.status === 'Selesai');

        if (pinjamanSelesai.length === 0) {
            listContainer.innerHTML = '<p class="text-gray-500 text-center">Belum ada riwayat peminjaman.</p>';
            return;
        }

        pinjamanSelesai.forEach(p => {
            const alatInfo = alat.find(a => a.id === p.alatId);
            listContainer.innerHTML += `
                <div class="bg-gray-50 p-3 rounded-lg border border-gray-200 opacity-70">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="font-semibold text-gray-700">${alatInfo.nama}</h3>
                            <p class="text-xs text-gray-500">Dikembalikan pada ${new Date(p.waktuKembali).toLocaleDateString('id-ID')}</p>
                        </div>
                        <span class="text-xs font-semibold bg-green-100 text-green-800 px-2 py-1 rounded-full">Selesai</span>
                    </div>
                </div>
            `;
        });
    }

    function renderDaftarAlatUser() {
        const listContainer = document.getElementById('user-daftar-alat-list');
        listContainer.innerHTML = '';
        alat.forEach(a => {
            const statusClass = a.tersedia > 0 ? 'text-green-600' : 'text-red-600';
            listContainer.innerHTML += `
                <li class="p-3 bg-gray-50 rounded-md flex justify-between items-center">
                    <span>${a.nama}</span> 
                    <span class="font-semibold ${statusClass}">Tersedia: ${a.tersedia}</span>
                </li>`;
        });
    }

    function renderAdminPeminjamanAktif() {
        const listContainer = document.getElementById('admin-peminjaman-aktif-list');
        listContainer.innerHTML = '';
        const pinjamanAktif = peminjaman.filter(p => p.status === 'Dipinjam');

        if (pinjamanAktif.length === 0) {
            listContainer.innerHTML = '<p class="text-gray-500 text-center">Tidak ada peminjaman aktif saat ini.</p>';
            return;
        }

        pinjamanAktif.forEach(p => {
            const userInfo = users.find(u => u.identifier === p.userId);
            const alatInfo = alat.find(a => a.id === p.alatId);
            listContainer.innerHTML += `
                <div class="bg-white p-4 rounded-lg border border-yellow-400 border-2">
                     <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-primary">${userInfo.nama} (${userInfo.type})</h3>
                            <p class="text-sm text-gray-600">Alat: ${alatInfo.nama}</p>
                            <p class="text-xs text-gray-500">Batas Kembali: ${new Date(p.batasKembali).toLocaleString('id-ID')}</p>
                        </div>
                        <span class="text-xs font-semibold bg-blue-100 text-blue-800 px-2 py-1 rounded-full">Dipinjam</span>
                    </div>
                </div>
            `;
        });
    }

    function renderKelolaAlatAdmin() {
        const listContainer = document.getElementById('admin-kelola-alat-list');
        listContainer.innerHTML = '';
        alat.forEach(a => {
            listContainer.innerHTML += `
                <div class="p-3 bg-gray-50 rounded-md flex justify-between items-center">
                    <div>
                        <p class="font-semibold">${a.nama}</p>
                        <p class="text-xs text-gray-500">Jumlah: ${a.jumlah} | Tersedia: ${a.tersedia}</p>
                    </div>
                    <div class="flex space-x-2">
                        <button class="text-blue-600 hover:text-blue-800" onclick="openEditAlatModal(${a.id})">Edit</button>
                        <button class="text-red-600 hover:text-red-800" onclick="hapusAlat(${a.id})">Hapus</button>
                    </div>
                </div>
            `;
        });
    }
    
    function renderAdminRiwayat() {
        const listContainer = document.getElementById('admin-riwayat-list');
        listContainer.innerHTML = '';
        [...peminjaman].reverse().forEach(p => {
            const userInfo = users.find(u => u.identifier === p.userId);
            const alatInfo = alat.find(a => a.id === p.alatId);
            const statusClass = p.status === 'Selesai' ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800';
            const waktu = p.status === 'Selesai' 
                ? `${new Date(p.waktuPinjam).toLocaleString('id-ID')} - ${new Date(p.waktuKembali).toLocaleString('id-ID')}`
                : `${new Date(p.waktuPinjam).toLocaleString('id-ID')} - Belum Kembali`;
            
            let detailHTML = '';
            if (p.detail && p.detail.keperluan === 'Mata Kuliah') {
                detailHTML = `
                    <div class="text-xs bg-gray-100 p-2 mt-2 rounded border">
                        <p><span class="font-semibold">Keperluan:</span> ${p.detail.keperluan}</p>
                        <p><span class="font-semibold">Matkul:</span> ${p.detail.matkul} (${p.detail.kelas})</p>
                        <p><span class="font-semibold">Dosen:</span> ${p.detail.dosen}</p>
                    </div>
                `;
            } else if (p.detail && p.detail.keperluan === 'Mengajar') {
                detailHTML = `
                    <div class="text-xs bg-gray-100 p-2 mt-2 rounded border">
                        <p><span class="font-semibold">Keperluan:</span> ${p.detail.keperluan}</p>
                        <p><span class="font-semibold">Matkul:</span> ${p.detail.matkul}</p>
                        <p><span class="font-semibold">Kelas:</span> ${p.detail.kelas}</p>
                    </div>
                `;
            } else if (p.detail && p.detail.keperluan === 'Kegiatan Kampus') {
                detailHTML = `
                    <div class="text-xs bg-gray-100 p-2 mt-2 rounded border">
                        <p><span class="font-semibold">Keperluan:</span> ${p.detail.keperluan}</p>
                        <p><span class="font-semibold">Kegiatan:</span> ${p.detail.kegiatan}</p>
                        <p><span class="font-semibold">Lokasi:</span> ${p.detail.lokasi}</p>
                    </div>
                `;
            } else if (p.detail) {
                detailHTML = `<p class="text-xs mt-2"><span class="font-semibold">Keperluan:</span> ${p.detail.keperluan}</p>`;
            }


            listContainer.innerHTML += `
                <div class="bg-gray-50 p-4 rounded-lg border">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="font-bold text-primary">${userInfo.nama} (${userInfo.type})</p>
                            <p class="text-sm text-gray-600">${userInfo.type === 'mahasiswa' ? 'NIM' : 'NIP'}: ${userInfo.identifier}</p>
                        </div>
                        <span class="text-xs font-semibold ${statusClass} px-2 py-1 rounded-full">${p.status}</span>
                    </div>
                    <div class="text-sm space-y-1 text-gray-700">
                        <p><span class="font-semibold">Alat:</span> ${alatInfo.nama}</p>
                        ${detailHTML}
                        <p class="text-xs text-gray-500 mt-2">
                            <span class="font-semibold">Waktu:</span> ${waktu}
                        </p>
                    </div>
                </div>
            `;
        });
    }


    // Fungsi Aksi (CRUD)
    function ajukanPeminjaman() {
        const alatId = parseInt(document.getElementById('pinjam-jenis-alat').value);
        const waktuPinjam = document.getElementById('pinjam-waktu-pinjam').value;
        const batasKembali = document.getElementById('pinjam-waktu-kembali').value;

        if (!alatId || !waktuPinjam || !batasKembali) {
            showToast("Harap lengkapi semua data peminjaman.");
            return;
        }

        const targetAlat = alat.find(a => a.id === alatId);
        if (targetAlat.tersedia <= 0) {
            showToast("Maaf, alat ini tidak tersedia saat ini.");
            return;
        }

        let keperluanDetail = {};
        if (currentUser.type === 'mahasiswa') {
            const keperluan = document.getElementById('pinjam-keperluan-mhs').value;
            if (keperluan === 'matakuliah') {
                const matkul = document.getElementById('pinjam-matkul').value;
                const dosen = document.getElementById('pinjam-dosen').value;
                const kelas = document.getElementById('pinjam-kelas').value;
                if (!matkul || !dosen || !kelas) {
                    showToast("Harap lengkapi detail mata kuliah.");
                    return;
                }
                keperluanDetail = { keperluan: 'Mata Kuliah', matkul, dosen, kelas };
            } else if (keperluan === 'lainnya') {
                keperluanDetail = { keperluan: 'Lainnya' };
            } else {
                 showToast("Harap pilih keperluan peminjaman.");
                return;
            }
        } else if (currentUser.type === 'dosen') {
            const keperluan = document.getElementById('pinjam-keperluan-dosen').value;
            if (keperluan === 'mengajar') {
                const matkul = document.getElementById('pinjam-matkul-dosen').value;
                const kelas = document.getElementById('pinjam-kelas-dosen').value;
                if (!matkul || !kelas) {
                    showToast("Harap lengkapi detail mengajar.");
                    return;
                }
                keperluanDetail = { keperluan: 'Mengajar', matkul, kelas };
            } else if (keperluan === 'lainnya') {
                keperluanDetail = { keperluan: 'Lainnya' };
            } else {
                showToast("Harap pilih keperluan peminjaman.");
                return;
            }
        } else if (currentUser.type === 'pegawai') {
            const keperluan = document.getElementById('pinjam-keperluan-pegawai').value;
            if (keperluan === 'kegiatan') {
                const kegiatan = document.getElementById('pinjam-kegiatan').value;
                const lokasi = document.getElementById('pinjam-lokasi').value;
                if (!kegiatan || !lokasi) {
                    showToast("Harap lengkapi detail kegiatan.");
                    return;
                }
                keperluanDetail = { keperluan: 'Kegiatan Kampus', kegiatan, lokasi };
            } else if (keperluan === 'lainnya') {
                keperluanDetail = { keperluan: 'Lainnya' };
            } else {
                showToast("Harap pilih keperluan peminjaman.");
                return;
            }
        }

        peminjaman.push({
            id: nextPeminjamanId++,
            userId: currentUser.identifier,
            alatId: alatId,
            waktuPinjam: waktuPinjam,
            batasKembali: batasKembali,
            detail: keperluanDetail,
            status: 'Dipinjam',
        });

        targetAlat.tersedia--;

        closeModal('peminjaman-modal');
        showToast("Peminjaman berhasil diajukan!");
        updateUserDashboard();
        updateAdminDashboard(); // Agar admin juga melihat peminjaman baru
    }
    
    function openKembalikanModal(peminjamanId) {
        document.getElementById('form-kembalikan').dataset.peminjamanId = peminjamanId;
        showModal('kembalikan-modal');
    }

    function kembalikanAlat() {
        const peminjamanId = parseInt(document.getElementById('form-kembalikan').dataset.peminjamanId);
        const pinjaman = peminjaman.find(p => p.id === peminjamanId);
        
        if (pinjaman) {
            pinjaman.status = 'Selesai';
            pinjaman.waktuKembali = new Date().toISOString().slice(0, 16);
            const targetAlat = alat.find(a => a.id === pinjaman.alatId);
            targetAlat.tersedia++;
        }

        closeModal('kembalikan-modal');
        showToast("Alat berhasil dikembalikan.");
        updateUserDashboard();
        updateAdminDashboard();
    }
    
    function simpanAlatBaru() {
        const nama = document.getElementById('input-nama-alat').value;
        const jumlah = parseInt(document.getElementById('input-jumlah-alat').value);
        const kelengkapan = document.getElementById('input-kelengkapan-alat').value;
        const deskripsi = document.getElementById('input-deskripsi-alat').value;

        const newAlat = {
            id: alat.length > 0 ? Math.max(...alat.map(a => a.id)) + 1 : 1,
            nama: nama,
            jumlah: jumlah,
            tersedia: jumlah,
            kelengkapan: kelengkapan,
            deskripsi: deskripsi
        };
        alat.push(newAlat);
        
        closeModal('input-alat-modal');
        showToast("Alat baru berhasil disimpan.");
        document.getElementById('form-input-alat').reset();
    }
    
    function hapusAlat(alatId) {
        if (confirm("Apakah Anda yakin ingin menghapus alat ini? Aksi ini tidak dapat dibatalkan.")) {
            alat = alat.filter(a => a.id !== alatId);
            showToast("Alat berhasil dihapus.");
            renderKelolaAlatAdmin();
        }
    }
    
    function openEditAlatModal(alatId) {
        const targetAlat = alat.find(a => a.id === alatId);
        if (targetAlat) {
            document.getElementById('edit-alat-id').value = targetAlat.id;
            document.getElementById('edit-nama-alat').value = targetAlat.nama;
            document.getElementById('edit-jumlah-alat').value = targetAlat.jumlah;
            document.getElementById('edit-kelengkapan-alat').value = targetAlat.kelengkapan;
            document.getElementById('edit-deskripsi-alat').value = targetAlat.deskripsi;
            
            closeModal('daftar-alat-admin-modal');
            showModal('edit-alat-modal');
        }
    }

    function simpanPerubahanAlat() {
        const alatId = parseInt(document.getElementById('edit-alat-id').value);
        const targetAlat = alat.find(a => a.id === alatId);

        if (targetAlat) {
            const jumlahLama = targetAlat.jumlah;
            const jumlahBaru = parseInt(document.getElementById('edit-jumlah-alat').value);
            const selisih = jumlahBaru - jumlahLama;

            targetAlat.nama = document.getElementById('edit-nama-alat').value;
            targetAlat.jumlah = jumlahBaru;
            targetAlat.kelengkapan = document.getElementById('edit-kelengkapan-alat').value;
            targetAlat.deskripsi = document.getElementById('edit-deskripsi-alat').value;
            targetAlat.tersedia += selisih;
        }
        
        closeModal('edit-alat-modal');
        showToast("Data alat berhasil diperbarui.");
    }


    // ===================================================================
    //                           HELPER FUNCTIONS
    // ===================================================================
    function switchLoginTab(tab) {
        if (tab === 'user') {
            document.getElementById('login-user-tab').classList.replace('tab-inactive', 'tab-active');
            document.getElementById('login-admin-tab').classList.replace('tab-active', 'tab-inactive');
            document.getElementById('login-user-form').classList.remove('hidden');
            document.getElementById('login-admin-form').classList.add('hidden');
        } else {
            document.getElementById('login-user-tab').classList.replace('tab-active', 'tab-inactive');
            document.getElementById('login-admin-tab').classList.replace('tab-inactive', 'tab-active');
            document.getElementById('login-user-form').classList.add('hidden');
            document.getElementById('login-admin-form').classList.remove('hidden');
        }
    }

    function switchLoginFormIdentifier(type) {
        const label = document.querySelector('#login-nim-input label');
        const input = document.getElementById('login-identifier');
        if (type === 'mahasiswa') {
            label.textContent = 'NIM';
            input.placeholder = 'Masukkan NIM';
        } else {
            label.textContent = 'NIP';
            input.placeholder = 'Masukkan NIP';
        }
    }

    function switchRegisterForm(type) {
        if (type === 'mahasiswa') {
            document.getElementById('register-mahasiswa-form').classList.remove('hidden');
            document.getElementById('register-dosen-pegawai-form').classList.add('hidden');
        } else {
            document.getElementById('register-mahasiswa-form').classList.add('hidden');
            document.getElementById('register-dosen-pegawai-form').classList.remove('hidden');
        }
    }
    
    function preparePeminjamanForm() {
        document.getElementById('form-peminjaman').reset();
        document.getElementById('peminjaman-form-mahasiswa').classList.add('hidden');
        document.getElementById('peminjaman-form-dosen').classList.add('hidden');
        document.getElementById('peminjaman-form-pegawai').classList.add('hidden');
        document.getElementById('detail-matkul-form').classList.add('hidden');
        document.getElementById('detail-mengajar-form').classList.add('hidden');
        document.getElementById('detail-kegiatan-form').classList.add('hidden');


        const selectAlat = document.getElementById('pinjam-jenis-alat');
        selectAlat.innerHTML = '<option value="" disabled selected>Pilih alat...</option>';
        alat.filter(a => a.tersedia > 0).forEach(a => {
            selectAlat.innerHTML += `<option value="${a.id}">${a.nama}</option>`;
        });

        if (currentUser.type === 'mahasiswa') {
            document.getElementById('peminjaman-form-mahasiswa').classList.remove('hidden');
        } else if (currentUser.type === 'dosen') {
             documen
