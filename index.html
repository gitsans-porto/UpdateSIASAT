<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InventaJur - Sistem Inventaris Jurusan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Menggunakan font yang bersih dan modern */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom scrollbar untuk tampilan yang lebih bersih */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #800000;
            border-radius: 6px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #a00000;
        }
        .hidden {
            display: none;
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
    <script>
        // Konfigurasi warna custom untuk Tailwind CSS
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#800000', // Maroon
                        'primary-dark': '#660000',
                        secondary: '#FFD700', // Kuning (Gold)
                        'secondary-dark': '#E6C200',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100">

    <div id="app" class="max-w-md mx-auto bg-white min-h-screen shadow-2xl">

        <!-- ===== HALAMAN SPLASH ===== -->
        <main id="splashPage" class="flex flex-col items-center justify-center min-h-screen p-6 bg-primary">
            <div class="text-center text-white mb-12">
                <i data-lucide="archive" class="w-24 h-24 mx-auto text-secondary"></i>
                <h1 class="text-4xl font-bold mt-4">InventaJur</h1>
                <p class="text-lg text-yellow-200">Sistem Inventaris Peralatan Jurusan</p>
            </div>
            <div class="w-full space-y-4">
                 <button id="goToLoginBtn" class="w-full bg-white text-primary font-bold py-4 px-4 rounded-lg text-lg shadow-lg hover:bg-gray-100 transition-colors duration-300">
                    Login
                </button>
                 <button id="goToRegisterBtn" class="w-full bg-secondary text-primary font-bold py-4 px-4 rounded-lg text-lg shadow-lg hover:bg-secondary-dark transition-colors duration-300">
                    Registrasi
                </button>
            </div>
        </main>

        <!-- ===== HALAMAN LOGIN ===== -->
        <main id="loginPage" class="hidden min-h-screen p-6 bg-gray-100">
             <button class="back-to-splash-btn flex items-center text-primary font-semibold mb-6">
                <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i>
                Kembali
            </button>
            <h2 class="text-3xl font-bold text-primary mb-2">Login Akun</h2>
            <p class="text-gray-600 mb-6">Pilih tipe akun Anda untuk melanjutkan.</p>
            
            <div class="mb-5">
                <label for="loginUserType" class="block text-sm font-medium text-gray-700 mb-1">Saya ingin login sebagai:</label>
                <select id="loginUserType" class="w-full p-3 border border-gray-300 rounded-lg bg-white">
                    <option value="">-- Pilih Tipe Akun --</option>
                    <option value="mahasiswa">Mahasiswa</option>
                    <option value="dosen">Dosen / Pegawai</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            
            <div id="loginFormContainer">
                <!-- Form login dinamis akan muncul di sini -->
            </div>
        </main>

        <!-- ===== HALAMAN REGISTRASI ===== -->
        <main id="registerPage" class="hidden min-h-screen p-6 bg-gray-100">
            <button class="back-to-splash-btn flex items-center text-primary font-semibold mb-6">
                <i data-lucide="arrow-left" class="w-5 h-5 mr-2"></i>
                Kembali
            </button>
            <h2 class="text-3xl font-bold text-primary mb-2">Buat Akun Baru</h2>
            <p class="text-gray-600 mb-6">Pilih tipe akun yang ingin Anda daftarkan.</p>

            <div class="mb-5">
                <label for="registerUserType" class="block text-sm font-medium text-gray-700 mb-1">Saya ingin mendaftar sebagai:</label>
                <select id="registerUserType" class="w-full p-3 border border-gray-300 rounded-lg bg-white">
                    <option value="">-- Pilih Tipe Akun --</option>
                    <option value="mahasiswa">Mahasiswa</option>
                    <option value="dosen">Dosen</option>
                    <option value="pegawai">Pegawai</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            
            <form id="registerForm" class="hidden">
                 <!-- Form registrasi dinamis akan muncul di sini -->
                <div id="registerFormContainer" class="space-y-4"></div>

                <!-- Common fields -->
                <div class="mt-4 space-y-4">
                    <div>
                        <label for="regPassword" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="regPassword" class="mt-1 w-full p-3 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                        <label for="regConfirmPassword" class="block text-sm font-medium text-gray-700">Konfirmasi Password</label>
                        <input type="password" id="regConfirmPassword" class="mt-1 w-full p-3 border border-gray-300 rounded-lg" required>
                    </div>
                </div>
                <button type="submit" class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg hover:bg-primary-dark mt-6">Registrasi</button>
            </form>
        </main>

        <!-- ===== HALAMAN PENGGUNA (Mahasiswa, Dosen, dll) ===== -->
        <main id="userHomePage" class="hidden">
            <div id="userPageContent" class="pb-20">
                <!-- Konten akan dirender oleh JS -->
            </div>
            
            <!-- Navbar Bawah -->
            <nav id="userBottomNav" class="fixed bottom-0 left-0 right-0 max-w-md mx-auto bg-white border-t border-gray-200 flex justify-around items-center h-16 shadow-lg">
                <a href="#" data-page="home" class="user-nav-link text-primary flex flex-col items-center justify-center w-1/5">
                    <i data-lucide="home" class="w-6 h-6"></i><span class="text-xs font-medium">Beranda</span>
                </a>
                <a href="#" data-page="borrow" class="user-nav-link text-gray-500 flex flex-col items-center justify-center w-1/5">
                    <i data-lucide="shopping-basket" class="w-6 h-6"></i><span class="text-xs font-medium">Pinjam</span>
                </a>
                <a href="#" data-page="return" class="user-nav-link text-gray-500 flex flex-col items-center justify-center w-1/5">
                    <i data-lucide="undo-2" class="w-6 h-6"></i><span class="text-xs font-medium">Kembalikan</span>
                </a>
                <a href="#" data-page="history" class="user-nav-link text-gray-500 flex flex-col items-center justify-center w-1/5">
                    <i data-lucide="history" class="w-6 h-6"></i><span class="text-xs font-medium">Riwayat</span>
                </a>
                 <a href="#" data-page="profile" class="user-nav-link text-gray-500 flex flex-col items-center justify-center w-1/5">
                    <i data-lucide="user-circle" class="w-6 h-6"></i><span class="text-xs font-medium">Profil</span>
                </a>
            </nav>
        </main>
        
        <!-- ===== HALAMAN ADMIN ===== -->
        <main id="adminDashboardPage" class="hidden">
            <header class="bg-primary text-white p-4 flex justify-between items-center sticky top-0 z-10 shadow-md">
                <div>
                    <h1 class="text-xl font-bold">Dashboard Admin</h1>
                    <p id="adminName" class="text-sm text-yellow-200"></p>
                </div>
                <button id="adminLogoutBtn" class="p-2 rounded-full hover:bg-primary-dark">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </header>
            
            <div class="border-b border-gray-200">
                <nav class="flex justify-around -mb-px" aria-label="Tabs">
                    <a href="#" data-tab="input" class="admin-tab-link w-1/4 py-4 text-center font-medium text-sm text-primary border-b-2 border-primary">
                        <i data-lucide="plus-circle" class="mx-auto w-5 h-5 mb-1"></i> Input
                    </a>
                    <a href="#" data-tab="manage" class="admin-tab-link w-1/4 py-4 text-center font-medium text-sm text-gray-500 border-b-2 border-transparent">
                         <i data-lucide="edit" class="mx-auto w-5 h-5 mb-1"></i> Alat
                    </a>
                    <a href="#" data-tab="validation" class="admin-tab-link w-1/4 py-4 text-center font-medium text-sm text-gray-500 border-b-2 border-transparent relative">
                         <i data-lucide="check-square" class="mx-auto w-5 h-5 mb-1"></i> Validasi
                         <span id="validation-badge" class="hidden absolute top-2 right-2 w-4 h-4 bg-red-500 text-white text-xs font-bold rounded-full"></span>
                    </a>
                    <a href="#" data-tab="history" class="admin-tab-link w-1/4 py-4 text-center font-medium text-sm text-gray-500 border-b-2 border-transparent">
                         <i data-lucide="users" class="mx-auto w-5 h-5 mb-1"></i> Peminjam
                    </a>
                </nav>
            </div>
            
            <div class="p-4 pb-20">
                <!-- Konten Input Alat -->
                <div id="adminContentInput" class="admin-content-panel">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Tambah Data Alat Baru</h3>
                    <form id="addItemForm" class="space-y-4">
                        <div>
                            <label for="itemName" class="block text-sm font-medium text-gray-700">Nama Alat</label>
                            <input type="text" id="itemName" required class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="itemTotal" class="block text-sm font-medium text-gray-700">Jumlah Total</label>
                            <input type="number" id="itemTotal" min="1" required class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm">
                        </div>
                         <div>
                            <label for="itemCompleteness" class="block text-sm font-medium text-gray-700">Kelengkapan</label>
                            <input type="text" id="itemCompleteness" placeholder="cth: Kabel HDMI, Tas" required class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div>
                            <label for="itemDescription" class="block text-sm font-medium text-gray-700">Deskripsi (Opsional)</label>
                            <textarea id="itemDescription" rows="3" class="mt-1 block w-full p-3 border border-gray-300 rounded-md shadow-sm"></textarea>
                        </div>
                        <button type="submit" class="w-full bg-secondary text-primary font-bold py-3 px-4 rounded-lg hover:bg-secondary-dark transition-colors duration-300">
                            Tambah Alat
                        </button>
                    </form>
                </div>
                
                <!-- Konten Manajemen Alat -->
                <div id="adminContentManage" class="admin-content-panel hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Manajemen Data Alat</h3>
                    <div id="adminItemList" class="space-y-3">
                        <!-- Daftar alat akan dirender di sini -->
                    </div>
                </div>

                <!-- Konten Validasi Pengembalian -->
                <div id="adminContentValidation" class="admin-content-panel hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Validasi Pengembalian Alat</h3>
                    <div id="adminValidationList" class="space-y-3">
                        <!-- Daftar pengembalian akan dirender di sini -->
                    </div>
                </div>

                <!-- Konten Riwayat Peminjam -->
                <div id="adminContentHistory" class="admin-content-panel hidden">
                    <h3 class="text-lg font-semibold text-gray-800 mb-4">Riwayat Peminjaman Real-time</h3>
                    <div class="my-2">
                        <input type="date" id="historyDateFilter" class="w-full p-2 border rounded-md">
                    </div>
                    <div id="adminBorrowingHistory" class="space-y-3">
                        <!-- Riwayat Peminjaman akan dirender di sini -->
                    </div>
                </div>
            </div>
        </main>
        
        <!-- MODAL NOTIFIKASI -->
        <div id="notificationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
                <div id="notificationIcon" class="mx-auto mb-4"></div>
                <h3 id="notificationTitle" class="text-lg font-medium text-gray-900"></h3>
                <div class="mt-2">
                    <p id="notificationMessage" class="text-sm text-gray-500"></p>
                </div>
                <div class="mt-4">
                    <button type="button" id="notificationCloseBtn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-primary-dark">
                        Tutup
                    </button>
                </div>
            </div>
        </div>
        
        <!-- MODAL KONFIRMASI -->
        <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
            <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                    <i data-lucide="alert-triangle" class="h-6 w-6 text-red-600"></i>
                </div>
                <h3 id="confirmTitle" class="text-lg font-medium text-gray-900 mt-4"></h3>
                <p id="confirmMessage" class="text-sm text-gray-500 mt-2"></p>
                <div class="mt-5 sm:mt-6 sm:grid sm:grid-flow-row-dense sm:grid-cols-2 sm:gap-3">
                    <button id="confirmBtn" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700">
                        Hapus
                    </button>
                    <button id="cancelConfirmBtn" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0">
                        Batal
                    </button>
                </div>
            </div>
        </div>
        
        <!-- MODAL FORM PEMINJAMAN -->
        <div id="borrowModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-40 flex items-center justify-center p-4 overflow-y-auto">
             <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-auto">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-primary">Form Peminjaman</h3>
                    <button id="closeBorrowModalBtn" class="text-gray-500 hover:text-gray-800">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <form id="borrowForm" class="p-6 space-y-4">
                    <input type="hidden" id="borrowItemId">
                    <h4 id="borrowItemName" class="text-lg font-bold text-gray-800 text-center mb-4"></h4>
                    <div id="borrowDynamicFields" class="space-y-4"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                           <label for="borrowDate" class="block text-sm font-medium text-gray-700">Waktu Pinjam</label>
                           <input type="datetime-local" id="borrowDate" required class="mt-1 block w-full p-3 border border-gray-300 rounded-md">
                        </div>
                        <div>
                           <label for="returnDate" class="block text-sm font-medium text-gray-700">Batas Kembali</label>
                           <input type="datetime-local" id="returnDate" required class="mt-1 block w-full p-3 border border-gray-300 rounded-md">
                        </div>
                    </div>
                    <button type="submit" class="w-full bg-secondary text-primary font-bold py-3 px-4 rounded-lg hover:bg-secondary-dark transition-colors duration-300">
                        Ajukan Peminjaman
                    </button>
                </form>
            </div>
        </div>

        <!-- MODAL FORM PENGEMBALIAN -->
        <div id="returnModal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-40 flex items-center justify-center p-4 overflow-y-auto">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-auto">
               <div class="p-4 border-b flex justify-between items-center">
                   <h3 class="text-xl font-semibold text-primary">Form Pengembalian</h3>
                   <button id="closeReturnModalBtn" class="text-gray-500 hover:text-gray-800">
                       <i data-lucide="x" class="w-6 h-6"></i>
                   </button>
               </div>
               <form id="returnForm" class="p-6 space-y-4">
                   <input type="hidden" id="returnBorrowId">
                   <h4 id="returnItemName" class="text-lg font-bold text-gray-800 text-center mb-4"></h4>
                   
                   <div>
                       <label for="returnCondition" class="block text-sm font-medium text-gray-700">Kondisi Alat</label>
                       <select id="returnCondition" required class="mt-1 block w-full p-3 border border-gray-300 rounded-md">
                           <option value="Baik">Baik</option>
                           <option value="Rusak Ringan">Rusak Ringan</option>
                           <option value="Rusak Berat">Rusak Berat</option>
                           <option value="Hilang">Hilang</option>
                       </select>
                   </div>
                   <div>
                       <label for="returnNotes" class="block text-sm font-medium text-gray-700">Keterangan Tambahan (Opsional)</label>
                       <textarea id="returnNotes" rows="2" class="mt-1 block w-full p-3 border border-gray-300 rounded-md"></textarea>
                   </div>
                    <div>
                       <label for="returnProof" class="block text-sm font-medium text-gray-700">Bukti Pengembalian (Simulasi)</label>
                       <input type="text" id="returnProof" placeholder="cth: foto_alat.jpg" required class="mt-1 block w-full p-3 border border-gray-300 rounded-md">
                   </div>
                   
                   <button type="submit" class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg hover:bg-primary-dark transition-colors duration-300">
                       Ajukan Pengembalian
                   </button>
               </form>
           </div>
       </div>

    </div>

    <script>
        // Inisialisasi Lucide Icons
        lucide.createIcons();

        document.addEventListener('DOMContentLoaded', () => {
            // ===== ELEMEN DOM =====
            const pages = {
                splash: document.getElementById('splashPage'),
                login: document.getElementById('loginPage'),
                register: document.getElementById('registerPage'),
                userHome: document.getElementById('userHomePage'),
                adminDashboard: document.getElementById('adminDashboardPage')
            };
            // ... (sisa elemen DOM akan didefinisikan di sini)
            const borrowModal = document.getElementById('borrowModal');
            const closeBorrowModalBtn = document.getElementById('closeBorrowModalBtn');
            const borrowForm = document.getElementById('borrowForm');

            const returnModal = document.getElementById('returnModal');
            const closeReturnModalBtn = document.getElementById('closeReturnModalBtn');
            const returnForm = document.getElementById('returnForm');


            // ===== STATE APLIKASI =====
            let currentUser = null;
            let users = [];
            let items = [];
            let borrowings = [];

            // ===== FUNGSI UTILITAS & FUNGSI INTI (LOGIN, REGISTER, DLL) =====
            const showPage = (pageName) => {
                Object.values(pages).forEach(page => page.classList.add('hidden'));
                if (pages[pageName]) {
                    pages[pageName].classList.remove('hidden');
                }
            };
            
            const showNotification = (title, message, isSuccess = true) => {
                const notificationModal = document.getElementById('notificationModal');
                document.getElementById('notificationTitle').textContent = title;
                document.getElementById('notificationMessage').textContent = message;
                document.getElementById('notificationIcon').innerHTML = isSuccess
                    ? `<div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100"><i data-lucide="check" class="h-6 w-6 text-green-600"></i></div>`
                    : `<div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100"><i data-lucide="x" class="h-6 w-6 text-red-600"></i></div>`;
                lucide.createIcons();
                notificationModal.classList.remove('hidden');
            };

            const showConfirm = (title, message, onConfirm) => {
                const confirmModal = document.getElementById('confirmModal');
                const confirmBtn = document.getElementById('confirmBtn');
                document.getElementById('confirmTitle').textContent = title;
                document.getElementById('confirmMessage').textContent = message;
                confirmModal.classList.remove('hidden');
                lucide.createIcons(); 

                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                
                newConfirmBtn.addEventListener('click', () => {
                    onConfirm();
                    confirmModal.classList.add('hidden');
                }, { once: true });
                 document.getElementById('cancelConfirmBtn').addEventListener('click', () => {
                    confirmModal.classList.add('hidden');
                }, { once: true });
            };
            
            const saveData = () => {
                localStorage.setItem('inventajur_users', JSON.stringify(users));
                localStorage.setItem('inventajur_items', JSON.stringify(items));
                localStorage.setItem('inventajur_borrowings', JSON.stringify(borrowings));
            };

            const loadData = () => {
                users = JSON.parse(localStorage.getItem('inventajur_users')) || [];
                items = JSON.parse(localStorage.getItem('inventajur_items')) || [];
                borrowings = JSON.parse(localStorage.getItem('inventajur_borrowings')) || [];

                if (!users.some(u => u.type === 'admin')) {
                    users.push({ id: 'admin01', type: 'admin', name: 'Admin Utama', username: 'admin', password: 'admin' });
                    if(items.length === 0){
                         items.push(
                            { id: 1, name: 'Proyektor LCD', total: 5, available: 5, completeness: 'Kabel Power, Kabel HDMI, Tas', description: 'Proyektor Epson EB-X450' },
                            { id: 2, name: 'Stop Kontak', total: 10, available: 10, completeness: 'Panjang kabel 5 meter', description: 'Uticon 4 lubang' },
                            { id: 3, name: 'Konektor HDMI to VGA', total: 8, available: 8, completeness: 'Adapter only', description: 'Konverter aktif' }
                        );
                    }
                    saveData();
                }
            };

            const handleLogin = (e) => {
                e.preventDefault();
                const identifier = e.target.elements.loginIdentifier.value;
                const password = e.target.elements.loginPassword.value;
                const userType = document.getElementById('loginUserType').value;
                
                const foundUser = users.find(user => {
                    let typeMatch = false;
                    if (userType === 'dosen') {
                        typeMatch = user.type === 'dosen' || user.type === 'pegawai';
                    } else {
                        typeMatch = user.type === userType;
                    }

                    const idMatch = (user.nim === identifier || user.nip === identifier || user.username === identifier);
                    return typeMatch && idMatch && user.password === password;
                });

                if (foundUser) {
                    currentUser = foundUser;
                    sessionStorage.setItem('inventajur_currentUser', JSON.stringify(currentUser));
                    if (currentUser.type === 'admin') {
                        showPage('adminDashboard');
                        renderAdminDashboard();
                    } else {
                        showPage('userHome');
                        renderUserPage('home');
                    }
                } else {
                    showNotification('Login Gagal', 'Tipe akun, identifier, atau password salah.', false);
                }
                e.target.reset();
            };

            const handleRegister = (e) => {
                e.preventDefault();
                const type = document.getElementById('registerUserType').value;
                const password = document.getElementById('regPassword').value;
                const confirmPassword = document.getElementById('regConfirmPassword').value;

                if (password !== confirmPassword) {
                    showNotification('Registrasi Gagal', 'Password dan konfirmasi password tidak cocok.', false);
                    return;
                }
                
                let newUser = { id: Date.now().toString(), type, password };
                let identifier;
                const formElements = e.target.elements;

                if (type === 'mahasiswa') {
                    Object.assign(newUser, { name: formElements.regNama.value, nim: formElements.regNim.value, angkatan: formElements.regAngkatan.value, prodi: formElements.regProdi.value });
                    identifier = newUser.nim;
                } else if (type === 'dosen' || type === 'pegawai') {
                    Object.assign(newUser, { name: formElements.regNama.value, nip: formElements.regNip.value, jabatan: formElements.regJabatan.value });
                    identifier = newUser.nip;
                } else { // admin
                    Object.assign(newUser, { name: formElements.regNama.value, username: formElements.regUsername.value });
                    identifier = newUser.username;
                }
                
                const isExist = users.some(u => u.nim === identifier || u.nip === identifier || u.username === identifier);
                if (isExist) {
                    showNotification('Registrasi Gagal', `${type === 'mahasiswa' ? 'NIM' : (type === 'admin' ? 'Username' : 'NIP')} sudah terdaftar.`, false);
                    return;
                }
                
                users.push(newUser);
                saveData();
                showNotification('Registrasi Berhasil', 'Akun Anda telah dibuat. Silakan login.');
                showPage('login');
                 e.target.closest('form').reset();
                 document.getElementById('registerFormContainer').innerHTML = '';
                 document.getElementById('registerForm').classList.add('hidden');
            };
            
            const logout = () => {
                currentUser = null;
                sessionStorage.removeItem('inventajur_currentUser');
                showPage('splash');
            };

            const checkSession = () => {
                const userInSession = sessionStorage.getItem('inventajur_currentUser');
                if (userInSession) {
                    currentUser = JSON.parse(userInSession);
                    if (currentUser.type === 'admin') {
                        showPage('adminDashboard');
                        renderAdminDashboard();
                    } else {
                        showPage('userHome');
                        renderUserPage('home');
                    }
                } else {
                    showPage('splash');
                }
            };
            
            const renderBorrowDetailsFields = (purpose, userType) => {
                const detailsContainer = document.getElementById('borrowDetailsContainer');
                if (!detailsContainer) return;

                let detailsHtml = '';
                if (userType === 'mahasiswa') {
                    if (purpose === 'kuliah') {
                        detailsHtml = `
                            <div class="animate-fade-in"><label class="block text-sm font-medium text-gray-700">Mata Kuliah</label><input type="text" id="borrowCourse" required class="mt-1 block w-full p-3 border border-gray-300 rounded-md"></div>
                            <div class="animate-fade-in"><label class="block text-sm font-medium text-gray-700">Dosen Pengampu</label><input type="text" id="borrowLecturer" required class="mt-1 block w-full p-3 border border-gray-300 rounded-md"></div>
                            <div class="animate-fade-in"><label class="block text-sm font-medium text-gray-700">Kelas</label><input type="text" id="borrowClass" required class="mt-1 block w-full p-3 border border-gray-300 rounded-md"></div>
                        `;
                    } else { // 'lainnya'
                        detailsHtml = `
                            <div class="animate-fade-in"><label class="block text-sm font-medium text-gray-700">Deskripsi Keperluan</label><input type="text" id="borrowDescription" required class="mt-1 block w-full p-3 border border-gray-300 rounded-md"></div>
                            <div class="animate-fade-in"><label class="block text-sm font-medium text-gray-700">Lokasi Penggunaan</label><input type="text" id="borrowLocation" required class="mt-1 block w-full p-3 border border-gray-300 rounded-md"></div>
                        `;
                    }
                } else if (userType === 'dosen') {
                    if (purpose === 'mengajar') {
                        detailsHtml = `
                            <div class="animate-fade-in"><label class="block text-sm font-medium text-gray-700">Mata Kuliah</label><input type="text" id="borrowCourse" required class="mt-1 block w-full p-3 border border-gray-300 rounded-md"></div>
                            <div class="animate-fade-in"><label class="block text-sm font-medium text-gray-700">Kelas yang Diajar</label><input type="text" id="borrowClass" required class="mt-1 block w-full p-3 border border-gray-300 rounded-md"></div>
                        `;
                    } else { // 'lainnya'
                        detailsHtml = `
                            <div class="animate-fade-in"><label class="block text-sm font-medium text-gray-700">Deskripsi Keperluan</label><input type="text" id="borrowDescription" required class="mt-1 block w-full p-3 border border-gray-300 rounded-md"></div>
                            <div class="animate-fade-in"><label class="block text-sm font-medium text-gray-700">Lokasi Penggunaan</label><input type="text" id="borrowLocation" required class="mt-1 block w-full p-3 border border-gray-300 rounded-md"></div>
                        `;
                    }
                }
                detailsContainer.innerHTML = detailsHtml;
            };

            const renderLoginForm = (type) => {
                const container = document.getElementById('loginFormContainer');
                let formHTML = '';
                if (type === 'mahasiswa') {
                    formHTML = `<label class="block text-sm font-medium text-gray-700 mb-1">NIM</label><input type="text" name="loginIdentifier" required class="w-full p-3 border border-gray-300 rounded-lg">`;
                } else if (type === 'dosen') {
                    formHTML = `<label class="block text-sm font-medium text-gray-700 mb-1">NIP</label><input type="text" name="loginIdentifier" required class="w-full p-3 border border-gray-300 rounded-lg">`;
                } else if (type === 'admin') {
                    formHTML = `<label class="block text-sm font-medium text-gray-700 mb-1">Username</label><input type="text" name="loginIdentifier" required class="w-full p-3 border border-gray-300 rounded-lg">`;
                }
                
                if (formHTML) {
                    container.innerHTML = `
                    <form id="loginDynamicForm" class="animate-fade-in">
                        <div class="mb-4">${formHTML}</div>
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                            <input type="password" name="loginPassword" required class="w-full p-3 border border-gray-300 rounded-lg">
                        </div>
                        <button type="submit" class="w-full bg-primary text-white font-bold py-3 px-4 rounded-lg hover:bg-primary-dark">Login</button>
                    </form>`;
                    document.getElementById('loginDynamicForm').addEventListener('submit', handleLogin);
                } else {
                    container.innerHTML = '';
                }
            };
            
            const renderRegisterForm = (type) => {
                const container = document.getElementById('registerFormContainer');
                const form = document.getElementById('registerForm');
                let formHTML = '';
                 if (type === 'mahasiswa') {
                    formHTML = `
                        <div><label class="block text-sm font-medium">Nama Lengkap</label><input type="text" name="regNama" class="mt-1 w-full p-3 border border-gray-300 rounded-lg" required></div>
                        <div><label class="block text-sm font-medium">NIM</label><input type="text" name="regNim" class="mt-1 w-full p-3 border border-gray-300 rounded-lg" required></div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="block text-sm font-medium">Angkatan</label><input type="number" name="regAngkatan" class="mt-1 w-full p-3 border border-gray-300 rounded-lg" required></div>
                            <div><label class="block text-sm font-medium">Program Studi</label><input type="text" name="regProdi" class="mt-1 w-full p-3 border border-gray-300 rounded-lg" required></div>
                        </div>`;
                } else if (type === 'dosen' || type === 'pegawai') {
                    formHTML = `
                        <div><label class="block text-sm font-medium">Nama Lengkap</label><input type="text" name="regNama" class="mt-1 w-full p-3 border border-gray-300 rounded-lg" required></div>
                        <div><label class="block text-sm font-medium">NIP</label><input type="text" name="regNip" class="mt-1 w-full p-3 border border-gray-300 rounded-lg" required></div>
                        <div><label class="block text-sm font-medium">${type === 'dosen' ? 'Jabatan' : 'Jabatan / Bidang Kerja'}</label><input type="text" name="regJabatan" class="mt-1 w-full p-3 border border-gray-300 rounded-lg" required></div>`;
                } else if (type === 'admin') {
                     formHTML = `
                        <div><label class="block text-sm font-medium">Nama Lengkap</label><input type="text" name="regNama" class="mt-1 w-full p-3 border border-gray-300 rounded-lg" required></div>
                        <div><label class="block text-sm font-medium">Username</label><input type="text" name="regUsername" class="mt-1 w-full p-3 border border-gray-300 rounded-lg" required></div>`;
                }

                if(formHTML){
                    container.innerHTML = formHTML;
                    form.classList.remove('hidden');
                    form.classList.add('animate-fade-in');
                } else {
                    form.classList.add('hidden');
                    container.innerHTML = '';
                }
            };
            
            // ===== FUNGSI RENDER TAMPILAN PENGGUNA =====
            const renderUserPage = (page) => {
                const userPageContent = document.getElementById('userPageContent');
                document.querySelectorAll('.user-nav-link').forEach(link => {
                    link.classList.toggle('text-primary', link.dataset.page === page);
                    link.classList.toggle('text-gray-500', link.dataset.page !== page);
                });
                
                let content = '';
                if (page === 'home') content = renderUserHomePage();
                else if (page === 'borrow') content = renderUserBorrowPage();
                else if (page === 'return') content = renderUserReturnPage();
                else if (page === 'history') content = renderUserHistoryPage();
                else if (page === 'profile') content = renderUserProfilePage();
                
                userPageContent.innerHTML = content;
                lucide.createIcons();
                attachUserPageEventListeners();
            };

            const renderUserHomePage = () => {
                const userBorrowings = borrowings.filter(b => b.userId === currentUser.id && b.status === 'dipinjam').sort((a, b) => new Date(b.borrowDate) - new Date(a.borrowDate));
                
                let recentBorrowingsHTML = '<p class="text-center text-gray-500 mt-4">Tidak ada peminjaman aktif.</p>';
                if (userBorrowings.length > 0) {
                    recentBorrowingsHTML = userBorrowings.slice(0, 3).map(b => {
                        const item = items.find(i => i.id === b.itemId);
                        return `
                        <div class="bg-white p-4 rounded-lg shadow flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-gray-800">${item.name}</p>
                                <p class="text-sm text-gray-500">Batas kembali: ${new Date(b.returnDate).toLocaleString('id-ID')}</p>
                            </div>
                             <button data-page="return" class="nav-button-action bg-red-500 text-white text-sm font-bold py-2 px-3 rounded-lg">Kembalikan</button>
                        </div>`;
                    }).join('');
                }

                return `
                    <header class="bg-primary text-white p-5 sticky top-0 z-10 shadow-md rounded-b-3xl">
                        <div><p class="text-md text-yellow-200">Selamat Datang,</p><h1 class="text-2xl font-bold">${currentUser.name}</h1></div>
                    </header>
                    <div class="p-4 space-y-6">
                        <div class="grid grid-cols-2 gap-4">
                            <button data-page="borrow" class="nav-button-action bg-secondary p-6 rounded-2xl text-center text-primary font-bold shadow-lg hover:bg-secondary-dark transition">
                                <i data-lucide="shopping-basket" class="w-12 h-12 mx-auto mb-2"></i><span>Pinjam Alat</span>
                            </button>
                            <button data-page="return" class="nav-button-action bg-white p-6 rounded-2xl text-center text-primary font-bold shadow-lg hover:bg-gray-50 transition">
                                <i data-lucide="undo-2" class="w-12 h-12 mx-auto mb-2"></i><span>Kembalikan</span>
                            </button>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold text-gray-800 mb-2">Peminjaman Aktif</h3>
                            <div class="space-y-3">${recentBorrowingsHTML}</div>
                        </div>
                    </div>`;
            };
            
            const renderUserBorrowPage = () => {
                 const itemsHTML = items.map(item => `
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="flex justify-between items-start">
                             <div>
                                <h4 class="font-bold text-lg text-primary">${item.name}</h4>
                                <p class="text-sm text-gray-600">Tersedia: <span class="font-semibold">${item.available} dari ${item.total}</span></p>
                                <p class="text-xs text-gray-500 mt-1">Kelengkapan: ${item.completeness}</p>
                             </div>
                             ${item.available > 0 
                                ? `<button data-item-id="${item.id}" class="borrow-btn bg-primary text-white font-bold py-2 px-4 rounded-lg self-center">Pinjam</button>` 
                                : `<span class="bg-gray-200 text-gray-600 text-xs font-semibold px-3 py-1 rounded-full self-center">Habis</span>`}
                        </div>
                    </div>`).join('');
                return `
                    <header class="bg-white text-primary p-4 sticky top-0 z-10 shadow-md"><h1 class="text-xl font-bold text-center">Pinjam Peralatan</h1></header>
                    <div class="p-4 space-y-4">${itemsHTML || '<p class="text-center text-gray-500">Belum ada alat yang ditambahkan.</p>'}</div>`;
            };

            const renderUserReturnPage = () => {
                const userBorrowings = borrowings.filter(b => b.userId === currentUser.id && b.status === 'dipinjam');
                const itemsToReturnHTML = userBorrowings.length > 0
                    ? userBorrowings.map(b => {
                        const item = items.find(i => i.id === b.itemId);
                        return `
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="font-semibold text-gray-800">${item.name}</p>
                                    <p class="text-sm text-gray-500">Dipinjam: ${new Date(b.borrowDate).toLocaleDateString('id-ID')}</p>
                                </div>
                                <button data-borrow-id="${b.id}" class="return-item-btn bg-primary text-white font-bold py-2 px-4 rounded-lg">Kembalikan</button>
                            </div>
                        </div>`;
                    }).join('')
                    : '<p class="text-center text-gray-500 mt-4">Tidak ada alat yang sedang Anda pinjam.</p>';
                
                return `
                    <header class="bg-white text-primary p-4 sticky top-0 z-10 shadow-md"><h1 class="text-xl font-bold text-center">Pengembalian Alat</h1></header>
                    <div class="p-4 space-y-4">${itemsToReturnHTML}</div>`;
            };
            
            const renderUserHistoryPage = () => {
                 const userBorrowings = borrowings.filter(b => b.userId === currentUser.id).sort((a, b) => new Date(b.borrowDate) - new Date(a.borrowDate));
                let historyHTML = userBorrowings.length > 0
                    ? userBorrowings.map(b => {
                        const item = items.find(i => i.id === b.itemId);
                        let statusText, statusClass;
                        switch(b.status) {
                            case 'dipinjam':
                                statusText = 'Dipinjam';
                                statusClass = 'bg-yellow-100 text-yellow-800';
                                break;
                            case 'menunggu_validasi':
                                statusText = 'Menunggu Validasi';
                                statusClass = 'bg-blue-100 text-blue-800';
                                break;
                            case 'selesai':
                                statusText = `Selesai (${new Date(b.adminValidationDate).toLocaleDateString('id-ID')})`;
                                statusClass = 'bg-green-100 text-green-800';
                                break;
                            default:
                                statusText = 'N/A';
                                statusClass = 'bg-gray-100 text-gray-800';
                        }
                        
                        return `
                        <div class="bg-white p-4 rounded-lg shadow">
                            <div class="flex justify-between items-start">
                                <div>
                                    <p class="font-semibold text-gray-800">${item.name}</p>
                                    <p class="text-sm text-gray-500">Tgl Pinjam: ${new Date(b.borrowDate).toLocaleString('id-ID')}</p>
                                    <p class="text-sm text-gray-500">Keperluan: ${b.activity || b.description || `MK. ${b.course}` || 'Tidak ada keterangan'}</p>
                                </div>
                                <span class="text-xs font-semibold px-2 py-1 rounded-full ${statusClass}">${statusText}</span>
                            </div>
                        </div>`;
                    }).join('')
                    : '<p class="text-center text-gray-500 mt-4">Anda belum pernah meminjam alat.</p>';

                return `
                    <header class="bg-white text-primary p-4 sticky top-0 z-10 shadow-md"><h1 class="text-xl font-bold text-center">Riwayat Peminjaman</h1></header>
                    <div class="p-4 space-y-4">${historyHTML}</div>`;
            };
            
            const renderUserProfilePage = () => {
                let userDetails = '';
                if(currentUser.type === 'mahasiswa'){
                    userDetails = `
                        <p><span class="font-semibold">NIM:</span> ${currentUser.nim}</p>
                        <p><span class="font-semibold">Prodi:</span> ${currentUser.prodi}</p>
                        <p><span class="font-semibold">Angkatan:</span> ${currentUser.angkatan}</p>`;
                } else if (currentUser.type === 'dosen' || currentUser.type === 'pegawai') {
                    userDetails = `
                        <p><span class="font-semibold">NIP:</span> ${currentUser.nip}</p>
                        <p><span class="font-semibold">Jabatan:</span> ${currentUser.jabatan}</p>`;
                }

                return `
                    <header class="bg-white text-primary p-4 sticky top-0 z-10 shadow-md"><h1 class="text-xl font-bold text-center">Profil Saya</h1></header>
                    <div class="p-6">
                        <div class="bg-primary text-white p-6 rounded-xl text-center shadow-lg">
                            <i data-lucide="user-circle-2" class="w-20 h-20 mx-auto text-secondary"></i>
                            <h2 class="text-2xl font-bold mt-2">${currentUser.name}</h2>
                            <p class="text-yellow-200 capitalize">${currentUser.type}</p>
                        </div>
                        <div class="bg-white p-4 rounded-lg shadow mt-6 space-y-2 text-gray-700">
                           ${userDetails}
                        </div>
                        <button id="userLogoutBtn" class="w-full mt-6 bg-red-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-700 transition flex items-center justify-center">
                             <i data-lucide="log-out" class="w-5 h-5 mr-2"></i>
                            Logout
                        </button>
                    </div>`;
            };
            
            const handleBorrow = (itemId) => {
                const item = items.find(i => i.id == itemId);
                if (!item) return;

                document.getElementById('borrowItemId').value = item.id;
                document.getElementById('borrowItemName').textContent = item.name;
                
                const dynamicFieldsContainer = document.getElementById('borrowDynamicFields');
                const userType = currentUser.type;
                let purposeHtml = '';

                if (userType === 'mahasiswa') {
                    purposeHtml = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Keperluan</label>
                            <select id="borrowPurposeSelector" class="mt-1 block w-full p-3 border border-gray-300 rounded-md">
                                <option value="kuliah">Untuk Mata Kuliah</option>
                                <option value="lainnya">Lainnya</option>
                            </select>
                        </div>
                        <div id="borrowDetailsContainer" class="space-y-4 mt-4"></div>`;
                } else if (userType === 'dosen') {
                    purposeHtml = `
                         <div>
                            <label class="block text-sm font-medium text-gray-700">Keperluan</label>
                            <select id="borrowPurposeSelector" class="mt-1 block w-full p-3 border border-gray-300 rounded-md">
                                <option value="mengajar">Untuk Mengajar</option>
                                <option value="lainnya">Lainnya</option>
                            </select>
                        </div>
                        <div id="borrowDetailsContainer" class="space-y-4 mt-4"></div>`;
                } else if (userType === 'pegawai') {
                    purposeHtml = `
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Keperluan</label>
                            <input type="text" id="borrowActivity" placeholder="cth: Rapat Jurusan, Acara Kampus" required class="mt-1 block w-full p-3 border border-gray-300 rounded-md">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Lokasi Kegiatan</label>
                            <input type="text" id="borrowLocation" required class="mt-1 block w-full p-3 border border-gray-300 rounded-md">
                        </div>`;
                }
                
                dynamicFieldsContainer.innerHTML = purposeHtml;
                
                const purposeSelector = document.getElementById('borrowPurposeSelector');
                if (purposeSelector) {
                    purposeSelector.addEventListener('change', (e) => {
                        renderBorrowDetailsFields(e.target.value, userType);
                    });
                    renderBorrowDetailsFields(purposeSelector.value, userType);
                }

                borrowModal.classList.remove('hidden');
            };

            const handleBorrowSubmit = (e) => {
                e.preventDefault();
                const itemId = parseInt(document.getElementById('borrowItemId').value);
                const item = items.find(i => i.id === itemId);
                
                if (item.available < 1) {
                    showNotification('Gagal', 'Maaf, alat ini sedang tidak tersedia.', false);
                    return;
                }

                const newBorrowing = { 
                    id: Date.now(), 
                    itemId, 
                    userId: currentUser.id, 
                    borrowDate: document.getElementById('borrowDate').value, 
                    returnDate: document.getElementById('returnDate').value, 
                    status: 'dipinjam' // Status awal
                };
                
                const userType = currentUser.type;

                if (userType === 'mahasiswa' || userType === 'dosen') {
                    const purpose = document.getElementById('borrowPurposeSelector').value;
                    newBorrowing.purposeType = purpose;
                    if (purpose === 'kuliah' || purpose === 'mengajar') {
                        Object.assign(newBorrowing, {
                            course: document.getElementById('borrowCourse').value,
                            class: document.getElementById('borrowClass').value,
                        });
                        if (userType === 'mahasiswa') {
                            newBorrowing.lecturer = document.getElementById('borrowLecturer').value;
                        }
                    } else {
                         Object.assign(newBorrowing, {
                            description: document.getElementById('borrowDescription').value,
                            location: document.getElementById('borrowLocation').value,
                        });
                    }
                } else { // pegawai
                    Object.assign(newBorrowing, {
                        activity: document.getElementById('borrowActivity').value,
                        location: document.getElementById('borrowLocation').value,
                    });
                }

                borrowings.push(newBorrowing);
                item.available--;
                saveData();

                borrowModal.classList.add('hidden');
                borrowForm.reset();
                showNotification('Berhasil', 'Peminjaman Anda telah dicatat.');
                renderUserPage('history');
            };
            
            const showReturnForm = (borrowId) => {
                const borrowing = borrowings.find(b => b.id == borrowId);
                const item = items.find(i => i.id === borrowing.itemId);
                if (!borrowing || !item) return;

                document.getElementById('returnBorrowId').value = borrowId;
                document.getElementById('returnItemName').textContent = item.name;
                returnModal.classList.remove('hidden');
            };

            const handleReturnSubmit = (e) => {
                e.preventDefault();
                const borrowId = document.getElementById('returnBorrowId').value;
                const borrowing = borrowings.find(b => b.id == borrowId);

                if (borrowing) {
                    borrowing.status = 'menunggu_validasi';
                    borrowing.userReturnDate = new Date().toISOString();
                    borrowing.returnCondition = document.getElementById('returnCondition').value;
                    borrowing.returnNotes = document.getElementById('returnNotes').value;
                    borrowing.returnProof = document.getElementById('returnProof').value;
                    
                    saveData();
                    returnModal.classList.add('hidden');
                    returnForm.reset();
                    showNotification('Berhasil', 'Pengajuan pengembalian telah dikirim untuk divalidasi oleh Admin.');
                    renderUserPage('history');
                }
            };
            
            // ===== FUNGSI RENDER TAMPILAN ADMIN =====
            const renderAdminDashboard = () => {
                document.getElementById('adminName').textContent = currentUser.name;
                renderAdminPage('input');
            };
            
            const renderAdminPage = (page) => {
                document.querySelectorAll('.admin-tab-link').forEach(link => {
                    link.classList.remove('text-primary', 'border-primary');
                    link.classList.add('text-gray-500', 'border-transparent');
                });
                document.querySelector(`.admin-tab-link[data-tab="${page}"]`).classList.add('text-primary', 'border-primary');
                
                document.querySelectorAll('.admin-content-panel').forEach(content => content.classList.add('hidden'));
                document.getElementById(`adminContent${page.charAt(0).toUpperCase() + page.slice(1)}`).classList.remove('hidden');
                
                const pendingValidations = borrowings.filter(b => b.status === 'menunggu_validasi').length;
                const badge = document.getElementById('validation-badge');
                if (pendingValidations > 0) {
                    badge.textContent = pendingValidations;
                    badge.classList.remove('hidden');
                } else {
                    badge.classList.add('hidden');
                }

                if (page === 'manage') renderAdminItemList();
                else if (page === 'history') renderAdminBorrowingHistory();
                else if (page === 'validation') renderAdminValidationList();
            };
            
            const renderAdminItemList = () => {
                const itemListDiv = document.getElementById('adminItemList');
                itemListDiv.innerHTML = items.length > 0 ? items.map(item => `
                    <div class="bg-white p-3 rounded-lg shadow-sm border">
                        <div class="flex justify-between items-center">
                            <div>
                                <p class="font-semibold text-gray-800">${item.name}</p>
                                <p class="text-sm text-gray-500">Status: ${item.available} / ${item.total} tersedia</p>
                            </div>
                            <div class="flex space-x-2">
                                <button class="delete-item-btn p-2 text-red-600 hover:bg-red-100 rounded-full" data-item-id="${item.id}"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                    </div>`).join('') : '<p class="text-center text-gray-500">Belum ada alat.</p>';
                lucide.createIcons();
            };

            const renderAdminValidationList = () => {
                const validationDiv = document.getElementById('adminValidationList');
                const pendingReturns = borrowings.filter(b => b.status === 'menunggu_validasi');
                
                if (pendingReturns.length === 0) {
                    validationDiv.innerHTML = '<p class="text-center text-gray-500">Tidak ada pengembalian yang perlu divalidasi.</p>';
                    return;
                }

                validationDiv.innerHTML = pendingReturns.map(b => {
                    const item = items.find(i => i.id === b.itemId);
                    const user = users.find(u => u.id === b.userId);
                    return `
                        <div class="bg-white p-3 rounded-lg shadow-sm border space-y-2">
                            <p class="font-semibold">${item.name} <span class="font-normal text-sm">- oleh ${user.name}</span></p>
                            <div class="text-xs space-y-1 text-gray-600 border-t pt-2">
                                <p><b>Tgl Pengembalian:</b> ${new Date(b.userReturnDate).toLocaleString('id-ID')}</p>
                                <p><b>Kondisi:</b> <span class="font-semibold">${b.returnCondition}</span></p>
                                <p><b>Catatan:</b> ${b.returnNotes || '-'}</p>
                                <p><b>Bukti:</b> ${b.returnProof || '-'}</p>
                            </div>
                            <button data-borrow-id="${b.id}" class="validate-return-btn w-full mt-2 bg-green-600 text-white font-bold py-2 px-3 rounded-lg">Validasi & Selesaikan</button>
                        </div>
                    `;
                }).join('');
                lucide.createIcons();
            };
            
            const renderAdminBorrowingHistory = (filterDate = null) => {
                const historyDiv = document.getElementById('adminBorrowingHistory');
                let filteredBorrowings = [...borrowings].sort((a,b) => new Date(b.borrowDate) - new Date(a.borrowDate));
                
                if (filterDate) {
                    filteredBorrowings = filteredBorrowings.filter(b => new Date(b.borrowDate).toISOString().slice(0,10) === filterDate);
                }
                
                if (filteredBorrowings.length === 0) {
                    historyDiv.innerHTML = '<p class="text-center text-gray-500">Tidak ada riwayat peminjaman.</p>';
                    return;
                }

                historyDiv.innerHTML = filteredBorrowings.map(b => {
                    const item = items.find(i => i.id === b.itemId);
                    const user = users.find(u => u.id === b.userId);
                    
                    let statusText, statusClass;
                    switch(b.status) {
                        case 'dipinjam': statusText = 'Dipinjam'; statusClass = 'bg-yellow-100 text-yellow-800'; break;
                        case 'menunggu_validasi': statusText = 'Validasi'; statusClass = 'bg-blue-100 text-blue-800'; break;
                        case 'selesai': statusText = 'Selesai'; statusClass = 'bg-green-100 text-green-800'; break;
                        default: statusText = 'N/A'; statusClass = 'bg-gray-100 text-gray-800';
                    }

                    let userDetail = '';
                    if (user) {
                        if(user.type === 'mahasiswa') {
                             userDetail = `<p class="text-xs"><b>Peminjam:</b> ${user.name} (${user.nim})</p><p class="text-xs"><b>Detail:</b> ${b.purposeType === 'kuliah' ? `MK ${b.course}` : b.description}</p>`;
                        } else if (user.type === 'dosen') {
                            userDetail = `<p class="text-xs"><b>Peminjam:</b> ${user.name} (${user.nip})</p><p class="text-xs"><b>Detail:</b> ${b.purposeType === 'mengajar' ? `MK ${b.course}` : b.description}</p>`;
                        } else if (user.type === 'pegawai') {
                            userDetail = `<p class="text-xs"><b>Peminjam:</b> ${user.name} (${user.nip})</p><p class="text-xs"><b>Detail:</b> ${b.activity || '-'}</p>`;
                        }
                    }
                    
                    return `
                        <div class="bg-white p-3 rounded-lg shadow-sm border space-y-1">
                            <div class="flex justify-between items-start">
                                <p class="font-semibold">${item.name}</p>
                                <span class="text-xs font-semibold px-2 py-1 rounded-full ${statusClass}">${statusText}</span>
                            </div>
                            ${userDetail}
                            <p class="text-xs text-gray-50
