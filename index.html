<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pencatatan Keuangan Harian</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center px-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <div class="text-center mb-8">
                <div class="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <span class="text-3xl">🔐</span>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-2">Login Sistem</h1>
                <p class="text-gray-600">Masukkan kode akses untuk melanjutkan</p>
            </div>
            
            <form id="loginForm" class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Kode Akses</label>
                    <input type="text" id="accessCode" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-center text-lg font-mono" placeholder="Masukkan kode akses" required>
                </div>
                
                <button type="submit" id="loginBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 transform hover:scale-105">
                    🚀 Masuk Sistem
                </button>
            </form>
            
            <div id="loginError" class="hidden mt-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                <div class="text-center">
                    <div class="text-red-600 text-4xl mb-3">❌</div>
                    <h3 class="text-lg font-semibold text-red-800 mb-2">Kode Tidak Valid!</h3>
                    <p class="text-red-700 mb-4">Silahkan lakukan pembelian token di pemilik website! Klik tombol di bawah untuk melakukan pembelian</p>
                    <a href="https://wa.me/" target="_blank" class="inline-block bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 transform hover:scale-105">
                        💬 Hubungi via WhatsApp
                    </a>
                </div>
            </div>
            
            <div id="loginLoading" class="hidden mt-6 text-center">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="text-gray-600 mt-2">Memvalidasi kode...</p>
            </div>
        </div>
    </div>
    <!-- Main Application -->
    <div id="mainApp" class="hidden">
        <div class="container mx-auto px-4 py-8 max-w-6xl">
            <!-- Header -->
            <div class="text-center mb-8">
                <div class="flex justify-between items-center mb-4">
                    <div></div>
                    <h1 class="text-4xl font-bold text-gray-800">💰 Pencatatan Keuangan Harian</h1>
                    <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition duration-200">
                        🚪 Keluar
                    </button>
                </div>
                <p class="text-gray-600">Kelola keuangan Anda dengan mudah dan terorganisir</p>
            </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-green-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Pemasukan</p>
                        <p class="text-2xl font-bold text-green-600" id="totalIncome">Rp 0</p>
                    </div>
                    <div class="bg-green-100 p-3 rounded-full">
                        <span class="text-2xl">📈</span>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-red-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Pengeluaran</p>
                        <p class="text-2xl font-bold text-red-600" id="totalExpense">Rp 0</p>
                    </div>
                    <div class="bg-red-100 p-3 rounded-full">
                        <span class="text-2xl">📉</span>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-xl shadow-lg p-6 border-l-4 border-blue-500">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Saldo</p>
                        <p class="text-2xl font-bold text-blue-600" id="balance">Rp 0</p>
                    </div>
                    <div class="bg-blue-100 p-3 rounded-full">
                        <span class="text-2xl">💳</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Form Input -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
                    <span class="mr-2">📝</span> Input Transaksi
                </h2>
                
                <form id="transactionForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                        <input type="date" id="date" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipe</label>
                        <select id="type" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                            <option value="">Pilih Tipe</option>
                            <option value="income">Pemasukan</option>
                            <option value="expense">Pengeluaran</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                        <select id="category" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                            <option value="">Pilih Kategori</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah (Rp)</label>
                        <input type="number" id="amount" min="1" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="0" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Catatan</label>
                        <textarea id="notes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Catatan opsional..."></textarea>
                    </div>
                    
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-200 transform hover:scale-105">
                        💾 Simpan Transaksi
                    </button>
                </form>
            </div>

            <!-- Reports -->
            <div class="bg-white rounded-xl shadow-lg p-6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 flex items-center">
                    <span class="mr-2">📊</span> Laporan Keuangan
                </h2>
                
                <div class="mb-4">
                    <select id="reportPeriod" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="daily">Harian</option>
                        <option value="weekly">Mingguan</option>
                        <option value="monthly">Bulanan</option>
                        <option value="yearly">Tahunan</option>
                    </select>
                </div>
                
                <div class="mb-6">
                    <canvas id="reportChart" width="400" height="200"></canvas>
                </div>
                
                <div id="reportSummary" class="space-y-2">
                    <!-- Report summary will be populated here -->
                </div>
            </div>
        </div>

        <!-- Transaction History -->
        <div class="mt-8 bg-white rounded-xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-800 flex items-center">
                    <span class="mr-2">📋</span> Riwayat Transaksi
                </h2>
                <button id="clearAllBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition duration-200">
                    🗑️ Hapus Semua
                </button>
            </div>
            
            <!-- Date Filter -->
            <div class="mb-6 bg-gray-50 p-4 rounded-lg">
                <h3 class="text-lg font-medium text-gray-800 mb-4 flex items-center">
                    <span class="mr-2">🔍</span> Filter Berdasarkan Tanggal
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Dari Tanggal</label>
                        <input type="date" id="filterStartDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sampai Tanggal</label>
                        <input type="date" id="filterEndDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="flex items-end">
                        <button id="filterBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition duration-200">
                            🔍 Filter
                        </button>
                    </div>
                    <div class="flex items-end">
                        <button id="resetFilterBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-lg transition duration-200">
                            🔄 Reset
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full table-auto">
                    <thead>
                        <tr class="bg-gray-50">
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Tanggal</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Tipe</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Kategori</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Jumlah</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Catatan</th>
                            <th class="px-4 py-3 text-left text-sm font-medium text-gray-700">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="transactionHistory">
                        <!-- Transaction history will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-gray-800">✏️ Edit Transaksi</h3>
                <button id="closeEditModal" class="text-gray-500 hover:text-gray-700 text-2xl">×</button>
            </div>
            
            <form id="editTransactionForm" class="space-y-4">
                <input type="hidden" id="editTransactionId">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                    <input type="date" id="editDate" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Tipe</label>
                    <select id="editType" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        <option value="">Pilih Tipe</option>
                        <option value="income">Pemasukan</option>
                        <option value="expense">Pengeluaran</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Kategori</label>
                    <select id="editCategory" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                        <option value="">Pilih Kategori</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Jumlah (Rp)</label>
                    <input type="number" id="editAmount" min="1" step="0.01" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Catatan</label>
                    <textarea id="editNotes" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Catatan opsional..."></textarea>
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        💾 Simpan Perubahan
                    </button>
                    <button type="button" id="cancelEdit" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200">
                        ❌ Batal
                    </button>
                </div>
            </form>
        </div>
    </div>
    </div>

    <script>
        // Login System
        let validCodes = [];
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTI7Hm2J8pbYhfTVzrkgmJnVMHFkptUYcuMS3uZ3dvhFvdRmmLO9NNw-ywhl-BkLmvloDzYUPu8lCBQ/pub?output=csv';

        // Parse CSV properly handling quoted fields
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current.trim());
            return result;
        }

        // Load valid codes from CSV
        async function loadValidCodes() {
            try {
                console.log('Loading codes from:', CSV_URL);
                const response = await fetch(CSV_URL);
                const csvText = await response.text();
                console.log('CSV Response received, length:', csvText.length);
                console.log('First 500 characters:', csvText.substring(0, 500));
                
                const lines = csvText.split('\n').filter(line => line.trim().length > 0);
                console.log('Total lines:', lines.length);
                
                // Parse CSV and extract codes from "KODE LOGIN" column
                validCodes = [];
                
                if (lines.length > 1) {
                    // Parse header properly
                    const headers = parseCSVLine(lines[0]).map(h => h.replace(/"/g, '').trim());
                    console.log('Headers found:', headers);
                    
                    // Find column index for login codes
                    let codeColumnIndex = -1;
                    
                    // Try different variations of column names
                    const possibleNames = ['KODE LOGIN', 'KODE_LOGIN', 'LOGIN CODE', 'CODE', 'KODE'];
                    
                    for (let name of possibleNames) {
                        codeColumnIndex = headers.findIndex(h => 
                            h.toUpperCase().includes(name.toUpperCase())
                        );
                        if (codeColumnIndex !== -1) {
                            console.log('Found code column with name:', headers[codeColumnIndex], 'at index:', codeColumnIndex);
                            break;
                        }
                    }
                    
                    // If still not found, try the second column (index 1)
                    if (codeColumnIndex === -1 && headers.length >= 2) {
                        codeColumnIndex = 1;
                        console.log('Using second column as code column:', headers[codeColumnIndex]);
                    }
                    
                    if (codeColumnIndex !== -1) {
                        // Extract codes from the correct column
                        for (let i = 1; i < lines.length; i++) {
                            const columns = parseCSVLine(lines[i]).map(col => col.replace(/"/g, '').trim());
                            console.log(`Row ${i}:`, columns);
                            
                            if (columns[codeColumnIndex] && columns[codeColumnIndex].length > 0) {
                                const code = columns[codeColumnIndex].toUpperCase();
                                validCodes.push(code);
                                console.log('Added code:', code);
                            }
                        }
                    } else {
                        console.error('Could not find code column in headers:', headers);
                    }
                }
                
                console.log('Valid codes loaded:', validCodes);
                console.log('Total codes:', validCodes.length);
                
                // Add fallback codes if no codes were loaded
                if (validCodes.length === 0) {
                    console.log('No codes loaded, adding fallback codes');
                    validCodes = ['DEMO123', 'TEST456'];
                }
                
            } catch (error) {
                console.error('Error loading valid codes:', error);
                // Fallback codes for demo
                validCodes = ['DEMO123', 'TEST456'];
                console.log('Using fallback codes:', validCodes);
            }
        }

        // Validate access code
        function validateAccessCode(code) {
            return validCodes.includes(code.trim().toUpperCase());
        }

        // Show main application
        function showMainApp() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Initialize the main app
            initializeApp();
        }

        // Show login page
        function showLoginPage() {
            document.getElementById('loginPage').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            
            // Clear login form
            document.getElementById('accessCode').value = '';
            document.getElementById('loginError').classList.add('hidden');
            document.getElementById('loginLoading').classList.add('hidden');
        }

        // Handle login form submission
        async function handleLogin(event) {
            event.preventDefault();
            
            const accessCode = document.getElementById('accessCode').value.trim().toUpperCase();
            const loginBtn = document.getElementById('loginBtn');
            const loginError = document.getElementById('loginError');
            const loginLoading = document.getElementById('loginLoading');
            
            if (!accessCode) {
                return;
            }
            
            // Show loading
            loginLoading.classList.remove('hidden');
            loginError.classList.add('hidden');
            loginBtn.disabled = true;
            
            // Simulate validation delay
            setTimeout(() => {
                if (validateAccessCode(accessCode)) {
                    // Store login status
                    localStorage.setItem('isLoggedIn', 'true');
                    localStorage.setItem('accessCode', accessCode);
                    showMainApp();
                } else {
                    // Show error
                    loginError.classList.remove('hidden');
                }
                
                loginLoading.classList.add('hidden');
                loginBtn.disabled = false;
            }, 1500);
        }

        // Handle logout
        function handleLogout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('accessCode');
            showLoginPage();
        }

        // Check if user is already logged in
        function checkLoginStatus() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const storedCode = localStorage.getItem('accessCode');
            
            if (isLoggedIn === 'true' && storedCode && validateAccessCode(storedCode)) {
                showMainApp();
            } else {
                showLoginPage();
            }
        }

        // Initialize the main application
        function initializeApp() {
            // Set today's date as default
            document.getElementById('date').valueAsDate = new Date();
            
            // Initialize database
            initDB();
        }

        // IndexedDB setup
        let db;
        const dbName = 'FinanceTracker';
        const dbVersion = 1;

        // Categories
        const categories = {
            income: ['Gaji', 'Bonus', 'Investasi', 'Bisnis', 'Lainnya'],
            expense: ['Makanan', 'Transportasi', 'Belanja', 'Tagihan', 'Hiburan', 'Kesehatan', 'Lainnya']
        };

        // Initialize IndexedDB
        function initDB() {
            const request = indexedDB.open(dbName, dbVersion);
            
            request.onerror = function(event) {
                console.error('Database error:', event.target.error);
            };
            
            request.onsuccess = function(event) {
                db = event.target.result;
                loadTransactions();
                updateSummary();
                updateReport();
            };
            
            request.onupgradeneeded = function(event) {
                db = event.target.result;
                const objectStore = db.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                objectStore.createIndex('date', 'date', { unique: false });
                objectStore.createIndex('type', 'type', { unique: false });
            };
        }

        // Save transaction to IndexedDB
        function saveTransaction(transaction) {
            const request = db.transaction(['transactions'], 'readwrite')
                .objectStore('transactions')
                .add(transaction);
            
            request.onsuccess = function() {
                loadTransactions();
                updateSummary();
                updateReport();
            };
        }

        // Update transaction to IndexedDB
        function updateTransaction(id, transaction) {
            const request = db.transaction(['transactions'], 'readwrite')
                .objectStore('transactions')
                .put({ ...transaction, id: id });
            
            request.onsuccess = function() {
                loadTransactions();
                updateSummary();
                updateReport();
                closeEditModal();
            };
        }

        // Load all transactions
        function loadTransactions(filteredTransactions = null) {
            if (filteredTransactions) {
                displayTransactions(filteredTransactions);
                return;
            }
            
            const request = db.transaction(['transactions'], 'readonly')
                .objectStore('transactions')
                .getAll();
            
            request.onsuccess = function(event) {
                const transactions = event.target.result;
                displayTransactions(transactions);
            };
        }

        // Filter transactions by date range
        function filterTransactions() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            
            if (!startDate && !endDate) {
                loadTransactions();
                return;
            }
            
            const request = db.transaction(['transactions'], 'readonly')
                .objectStore('transactions')
                .getAll();
            
            request.onsuccess = function(event) {
                let transactions = event.target.result;
                
                if (startDate) {
                    transactions = transactions.filter(t => t.date >= startDate);
                }
                
                if (endDate) {
                    transactions = transactions.filter(t => t.date <= endDate);
                }
                
                displayTransactions(transactions);
            };
        }

        // Reset filter
        function resetFilter() {
            document.getElementById('filterStartDate').value = '';
            document.getElementById('filterEndDate').value = '';
            loadTransactions();
        }

        // Edit transaction
        function editTransaction(id) {
            const request = db.transaction(['transactions'], 'readonly')
                .objectStore('transactions')
                .get(id);
            
            request.onsuccess = function(event) {
                const transaction = event.target.result;
                if (transaction) {
                    openEditModal(transaction);
                }
            };
        }

        // Open edit modal
        function openEditModal(transaction) {
            document.getElementById('editTransactionId').value = transaction.id;
            document.getElementById('editDate').value = transaction.date;
            document.getElementById('editType').value = transaction.type;
            document.getElementById('editAmount').value = transaction.amount;
            document.getElementById('editNotes').value = transaction.notes || '';
            
            // Update categories for edit form
            updateEditCategories();
            
            // Set category after categories are loaded
            setTimeout(() => {
                document.getElementById('editCategory').value = transaction.category;
            }, 100);
            
            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('flex');
        }

        // Close edit modal
        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
            document.getElementById('editTransactionForm').reset();
        }

        // Update categories for edit form
        function updateEditCategories() {
            const type = document.getElementById('editType').value;
            const categorySelect = document.getElementById('editCategory');
            
            categorySelect.innerHTML = '<option value="">Pilih Kategori</option>';
            
            if (type && categories[type]) {
                categories[type].forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });
            }
        }

        // Delete transaction
        function deleteTransaction(id) {
            const request = db.transaction(['transactions'], 'readwrite')
                .objectStore('transactions')
                .delete(id);
            
            request.onsuccess = function() {
                loadTransactions();
                updateSummary();
                updateReport();
            };
        }

        // Clear all transactions
        function clearAllTransactions() {
            if (confirm('Apakah Anda yakin ingin menghapus semua transaksi?')) {
                const request = db.transaction(['transactions'], 'readwrite')
                    .objectStore('transactions')
                    .clear();
                
                request.onsuccess = function() {
                    loadTransactions();
                    updateSummary();
                    updateReport();
                };
            }
        }

        // Display transactions in table
        function displayTransactions(transactions) {
            const tbody = document.getElementById('transactionHistory');
            tbody.innerHTML = '';
            
            transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            transactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.className = 'border-b hover:bg-gray-50';
                
                const typeClass = transaction.type === 'income' ? 'text-green-600' : 'text-red-600';
                const typeIcon = transaction.type === 'income' ? '📈' : '📉';
                
                row.innerHTML = `
                    <td class="px-4 py-3 text-sm">${new Date(transaction.date).toLocaleDateString('id-ID')}</td>
                    <td class="px-4 py-3 text-sm ${typeClass} font-medium">${typeIcon} ${transaction.type === 'income' ? 'Pemasukan' : 'Pengeluaran'}</td>
                    <td class="px-4 py-3 text-sm">${transaction.category}</td>
                    <td class="px-4 py-3 text-sm font-semibold ${typeClass}">Rp ${transaction.amount.toLocaleString('id-ID')}</td>
                    <td class="px-4 py-3 text-sm text-gray-600">${transaction.notes || '-'}</td>
                    <td class="px-4 py-3 text-sm">
                        <button onclick="editTransaction(${transaction.id})" class="text-blue-600 hover:text-blue-800 font-medium mr-3">
                            ✏️ Edit
                        </button>
                        <button onclick="deleteTransaction(${transaction.id})" class="text-red-600 hover:text-red-800 font-medium">
                            🗑️ Hapus
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Update summary cards
        function updateSummary() {
            const request = db.transaction(['transactions'], 'readonly')
                .objectStore('transactions')
                .getAll();
            
            request.onsuccess = function(event) {
                const transactions = event.target.result;
                
                const totalIncome = transactions
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const totalExpense = transactions
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const balance = totalIncome - totalExpense;
                
                document.getElementById('totalIncome').textContent = `Rp ${totalIncome.toLocaleString('id-ID')}`;
                document.getElementById('totalExpense').textContent = `Rp ${totalExpense.toLocaleString('id-ID')}`;
                document.getElementById('balance').textContent = `Rp ${balance.toLocaleString('id-ID')}`;
                
                // Update balance color
                const balanceElement = document.getElementById('balance');
                if (balance >= 0) {
                    balanceElement.className = 'text-2xl font-bold text-green-600';
                } else {
                    balanceElement.className = 'text-2xl font-bold text-red-600';
                }
            };
        }

        // Chart instance
        let reportChart;

        // Update report chart
        function updateReport() {
            const period = document.getElementById('reportPeriod').value;
            
            const request = db.transaction(['transactions'], 'readonly')
                .objectStore('transactions')
                .getAll();
            
            request.onsuccess = function(event) {
                const transactions = event.target.result;
                const reportData = generateReportData(transactions, period);
                updateChart(reportData);
                updateReportSummary(reportData);
            };
        }

        // Generate report data based on period
        function generateReportData(transactions, period) {
            const now = new Date();
            const data = {};
            
            transactions.forEach(transaction => {
                const date = new Date(transaction.date);
                let key;
                
                switch (period) {
                    case 'daily':
                        if (date.toDateString() === now.toDateString()) {
                            key = 'Hari Ini';
                        } else {
                            return;
                        }
                        break;
                    case 'weekly':
                        const weekStart = new Date(now);
                        weekStart.setDate(now.getDate() - now.getDay());
                        if (date >= weekStart) {
                            key = 'Minggu Ini';
                        } else {
                            return;
                        }
                        break;
                    case 'monthly':
                        if (date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear()) {
                            key = 'Bulan Ini';
                        } else {
                            return;
                        }
                        break;
                    case 'yearly':
                        if (date.getFullYear() === now.getFullYear()) {
                            key = 'Tahun Ini';
                        } else {
                            return;
                        }
                        break;
                }
                
                if (!data[key]) {
                    data[key] = { income: 0, expense: 0 };
                }
                
                data[key][transaction.type] += transaction.amount;
            });
            
            return data;
        }

        // Update chart
        function updateChart(data) {
            const ctx = document.getElementById('reportChart').getContext('2d');
            
            if (reportChart) {
                reportChart.destroy();
            }
            
            const labels = Object.keys(data);
            const incomeData = labels.map(label => data[label].income || 0);
            const expenseData = labels.map(label => data[label].expense || 0);
            
            reportChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pemasukan',
                        data: incomeData,
                        backgroundColor: 'rgba(34, 197, 94, 0.8)',
                        borderColor: 'rgba(34, 197, 94, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Pengeluaran',
                        data: expenseData,
                        backgroundColor: 'rgba(239, 68, 68, 0.8)',
                        borderColor: 'rgba(239, 68, 68, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Rp ' + value.toLocaleString('id-ID');
                                }
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': Rp ' + context.parsed.y.toLocaleString('id-ID');
                                }
                            }
                        }
                    }
                }
            });
        }

        // Update report summary
        function updateReportSummary(data) {
            const summaryDiv = document.getElementById('reportSummary');
            summaryDiv.innerHTML = '';
            
            Object.keys(data).forEach(period => {
                const income = data[period].income || 0;
                const expense = data[period].expense || 0;
                const balance = income - expense;
                
                const summaryItem = document.createElement('div');
                summaryItem.className = 'bg-gray-50 p-4 rounded-lg';
                summaryItem.innerHTML = `
                    <h4 class="font-semibold text-gray-800 mb-2">${period}</h4>
                    <div class="grid grid-cols-3 gap-4 text-sm">
                        <div>
                            <span class="text-green-600 font-medium">📈 Pemasukan</span>
                            <p class="font-semibold">Rp ${income.toLocaleString('id-ID')}</p>
                        </div>
                        <div>
                            <span class="text-red-600 font-medium">📉 Pengeluaran</span>
                            <p class="font-semibold">Rp ${expense.toLocaleString('id-ID')}</p>
                        </div>
                        <div>
                            <span class="text-blue-600 font-medium">💳 Saldo</span>
                            <p class="font-semibold ${balance >= 0 ? 'text-green-600' : 'text-red-600'}">
                                Rp ${balance.toLocaleString('id-ID')}
                            </p>
                        </div>
                    </div>
                `;
                summaryDiv.appendChild(summaryItem);
            });
        }

        // Update categories based on type
        function updateCategories() {
            const type = document.getElementById('type').value;
            const categorySelect = document.getElementById('category');
            
            categorySelect.innerHTML = '<option value="">Pilih Kategori</option>';
            
            if (type && categories[type]) {
                categories[type].forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categorySelect.appendChild(option);
                });
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', async function() {
            // Load valid codes first
            await loadValidCodes();
            
            // Check login status
            checkLoginStatus();
            
            // Login form event
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Logout button event
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Form submission
            document.getElementById('transactionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const formData = {
                    date: document.getElementById('date').value,
                    type: document.getElementById('type').value,
                    category: document.getElementById('category').value,
                    amount: parseFloat(document.getElementById('amount').value),
                    notes: document.getElementById('notes').value
                };
                
                // Validation
                if (!formData.type || !formData.category) {
                    alert('Tipe dan kategori harus diisi!');
                    return;
                }
                
                if (formData.amount <= 0) {
                    alert('Jumlah harus lebih dari 0!');
                    return;
                }
                
                saveTransaction(formData);
                
                // Reset form
                this.reset();
                document.getElementById('date').valueAsDate = new Date();
                updateCategories();
                
                alert('Transaksi berhasil disimpan!');
            });
            
            // Type change event
            document.getElementById('type').addEventListener('change', updateCategories);
            
            // Report period change
            document.getElementById('reportPeriod').addEventListener('change', updateReport);
            
            // Clear all button
            document.getElementById('clearAllBtn').addEventListener('click', clearAllTransactions);
            
            // Filter buttons
            document.getElementById('filterBtn').addEventListener('click', filterTransactions);
            document.getElementById('resetFilterBtn').addEventListener('click', resetFilter);
            
            // Edit modal events
            document.getElementById('closeEditModal').addEventListener('click', closeEditModal);
            document.getElementById('cancelEdit').addEventListener('click', closeEditModal);
            
            // Edit form submission
            document.getElementById('editTransactionForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const id = parseInt(document.getElementById('editTransactionId').value);
                const formData = {
                    date: document.getElementById('editDate').value,
                    type: document.getElementById('editType').value,
                    category: document.getElementById('editCategory').value,
                    amount: parseFloat(document.getElementById('editAmount').value),
                    notes: document.getElementById('editNotes').value
                };
                
                // Validation
                if (!formData.type || !formData.category) {
                    alert('Tipe dan kategori harus diisi!');
                    return;
                }
                
                if (formData.amount <= 0) {
                    alert('Jumlah harus lebih dari 0!');
                    return;
                }
                
                updateTransaction(id, formData);
                alert('Transaksi berhasil diperbarui!');
            });
            
            // Edit type change event
            document.getElementById('editType').addEventListener('change', updateEditCategories);
            
            // Close modal when clicking outside
            document.getElementById('editModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeEditModal();
                }
            });
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9811a72af394ce39',t:'MTc1ODIwNjk5OC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
